<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <title>Security Event Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- External CSS -->
    <link rel="stylesheet" href="src/css/styles.css">
    
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- PDF Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
<div class="app-shell">
    <!-- ========== SIDEBAR ========== -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="brand">SECURITY<span>DASH</span></div>
            <div class="subtitle">Security Events Management Dashboard</div>
        </div>

        <!-- CSV Upload & Testmodus -->
        <div class="sidebar-section">
            <div class="sidebar-section-title">Datenquelle</div>

            <div class="file-input-wrapper">
                <label>
                    CSV-Datei fÃ¼r Ereignismeldungen auswÃ¤hlen
                    <input type="file" id="fileInput" accept=".csv" />
                </label>
                <div class="hint">
                    Erwartete Spalten z.B.: <strong>Land, Liegenschaft, Ereignisart, Datum</strong>
                </div>
                <div id="fileStatus" class="status">Keine Datei geladen.</div>
            </div>

            <button class="btn outline-light" id="loadTestData">
                Testdaten laden (Demo-Modus)
            </button>
            <div class="hint">
                Nutze den Testmodus, um das Dashboard ohne eigene CSV-Datei auszuprobieren.
            </div>
        </div>

        <!-- Filter -->
        <div class="sidebar-section">
            <div class="sidebar-section-title">Filter</div>
            <div class="filters">
                <div class="filter-row">
                    <label for="filterCountry">Land</label>
                    <select id="filterCountry">
                        <option value="__ALL__">Alle LÃ¤nder</option>
                    </select>
                </div>
                <div class="filter-row">
                    <label for="filterSite">Liegenschaft</label>
                    <select id="filterSite">
                        <option value="__ALL__">Alle Liegenschaften</option>
                    </select>
                </div>
                <div class="filter-row">
                    <label for="filterType">Ereignisart</label>
                    <select id="filterType">
                        <option value="__ALL__">Alle Ereignisarten</option>
                    </select>
                </div>
                <button class="btn secondary" id="resetFilters">Filter zurÃ¼cksetzen</button>
                <div id="filterStatus" class="status"></div>
            </div>
        </div>

        <!-- Export Section - NEU HINZUGEFÃœGT -->
        <div class="sidebar-section">
            <div class="sidebar-section-title">Export</div>
            
            <button class="btn secondary" id="exportCSV">
                ðŸ“„ CSV exportieren
            </button>
            <div class="hint">
                Exportiert die aktuell gefilterten Daten als CSV-Datei.
            </div>

            <button class="btn primary" id="exportPDF">
                ðŸ“Š PDF Report erstellen
            </button>
            <div class="hint">
                Erstellt einen professionellen PDF-Report mit allen Charts und Tabellen.
            </div>
            
            <div id="exportStatus" class="status" style="display: none;"></div>
        </div>
    </aside>

    <!-- ========== MAIN CONTENT ========== -->
    <main class="main">
        <!-- Header -->
        <header class="main-header">
            <div>
                <h1>Security Events Overview</h1>
                <h3>Echtzeit-Ãœbersicht Ã¼ber gemeldete Ereignisse nach Land, Liegenschaft und Ereignisart</h3>
            </div>
            <div class="main-header-right">
                <div class="pill">
                    <span id="recordCount">0</span> DatensÃ¤tze geladen
                </div>
                <div class="pill secondary" id="modeIndicator">
                    Modus: Keine Daten
                </div>
            </div>
        </header>

        <!-- KPI Cards -->
        <section class="card-grid" aria-label="Kennzahlen">
            <div class="card">
                <div class="card-title">Gesamtzahl Ereignisse</div>
                <div class="card-value" id="kpiTotalEvents">0</div>
                <div class="card-subvalue" id="kpiTotalEventsSub">0 nach Filter</div>
            </div>
            <div class="card">
                <div class="card-title">LÃ¤nder</div>
                <div class="card-value" id="kpiCountries">0</div>
                <div class="card-subvalue">Distinct nach Feld â€žLand"</div>
            </div>
            <div class="card">
                <div class="card-title">Liegenschaften</div>
                <div class="card-value" id="kpiSites">0</div>
                <div class="card-subvalue">Distinct nach Feld â€žLiegenschaft"</div>
            </div>
            <div class="card">
                <div class="card-title">Ereignisarten</div>
                <div class="card-value" id="kpiTypes">0</div>
                <div class="card-subvalue">Distinct nach Feld â€žEreignisart"</div>
            </div>
        </section>

        <!-- Grids -->
        <section class="content-grid">
            <!-- Left: Tables -->
            <section class="panel" aria-label="Tabellarische Auswertung">
                <div class="panel-header">
                    <div>
                        <div class="panel-title">Aggregierte Ãœbersicht</div>
                        <div class="panel-subtitle">
                            HÃ¤ufigkeiten nach Land, Liegenschaft und Ereignisart (inkl. aktiver Filter)
                        </div>
                    </div>
                </div>

                <h3>Nach Land</h3>
                <div class="table-wrapper">
                    <table id="tableByCountry">
                        <thead>
                        <tr>
                            <th>Land</th>
                            <th>Anzahl Ereignisse</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <h3>Nach Liegenschaft</h3>
                <div class="table-wrapper">
                    <table id="tableBySite">
                        <thead>
                        <tr>
                            <th>Liegenschaft</th>
                            <th>Land</th>
                            <th>Anzahl Ereignisse</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <h3>Nach Ereignisart</h3>
                <div class="table-wrapper">
                    <table id="tableByType">
                        <thead>
                        <tr>
                            <th>Ereignisart</th>
                            <th>Anzahl Ereignisse</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- Right: Charts & Benchmarks -->
            <section class="panel" aria-label="Visualisierung">
                <div class="panel-header">
                    <div>
                        <div class="panel-title">Visualisierung & Benchmark</div>
                        <div class="panel-subtitle">
                            Top-LÃ¤nder, Liegenschaften und Ereignisarten nach HÃ¤ufigkeit
                        </div>
                    </div>
                </div>

                <h3>Top LÃ¤nder (nach EreignishÃ¤ufigkeit)</h3>
                <div id="chartCountries" class="chart"></div>

                <h3>Top Liegenschaften</h3>
                <div id="chartSites" class="chart"></div>

                <h3>Top Ereignisarten</h3>
                <div id="chartTypes" class="chart"></div>
            </section>
        </section>
    </main>
</div>

<!-- JavaScript direkt in HTML - funktioniert garantiert -->
<script>
console.log('Dashboard startet...');

// =======================
// UTILITY FUNCTIONS
// =======================
function parseCSV(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
    if (lines.length === 0) return [];

    const delimiter = detectDelimiter(lines[0]);
    const headers = lines[0].split(delimiter).map(h => h.trim());

    const rows = [];
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        const cells = splitCSVLine(line, delimiter);
        if (cells.length === 1 && cells[0] === "") continue;
        const row = {};
        headers.forEach((h, idx) => {
            row[h] = (cells[idx] || "").trim();
        });
        rows.push(row);
    }
    return { headers, rows };
}

function detectDelimiter(headerLine) {
    const candidates = [",", ";", "\t"];
    let best = ",";
    let bestCount = 0;
    for (const d of candidates) {
        const count = headerLine.split(d).length;
        if (count > bestCount) {
            bestCount = count;
            best = d;
        }
    }
    return best;
}

function splitCSVLine(line, delimiter) {
    const result = [];
    let current = "";
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
        const c = line[i];
        if (c === '"') {
            inQuotes = !inQuotes;
            continue;
        }
        if (c === delimiter && !inQuotes) {
            result.push(current);
            current = "";
        } else {
            current += c;
        }
    }
    result.push(current);
    return result;
}

function createHeaderMap(headers) {
    const normalize = (s) =>
        s.toLowerCase()
            .replace(/\s+/g, "")
            .replace(/ÃŸ/g, "ss")
            .replace(/[^a-z0-9]/g, "");

    const map = {};
    const targetNames = {
        country: ["land", "country"],
        site: ["liegenschaft", "site", "standort"],
        type: ["ereignisart", "ereignissart", "eventtype", "ereignis"]
    };

    const normalized = headers.map(h => ({ header: h, norm: normalize(h) }));

    for (const n of normalized) {
        const val = n.norm;
        if (targetNames.country.some(t => val.includes(t))) {
            map.country = n.header;
        }
        if (targetNames.site.some(t => val.includes(t))) {
            map.site = n.header;
        }
        if (targetNames.type.some(t => val.includes(t))) {
            map.type = n.header;
        }
    }

    return map;
}

function groupAndCount(rows, keyFn) {
    const map = new Map();
    for (const row of rows) {
        const key = keyFn(row);
        if (!key) continue;
        map.set(key, (map.get(key) || 0) + 1);
    }
    return Array.from(map.entries())
        .map(([key, count]) => ({ key, count }))
        .sort((a, b) => b.count - a.count);
}

function getTestData() {
    return `Land;Liegenschaft;Ereignisart;Datum
Deutschland;Mainz Campus;Zutrittsverletzung;2025-01-03
Deutschland;Mainz Campus;Zutrittsverletzung;2025-01-04
Deutschland;Mainz Campus;Alarmanlage ausgelÃ¶st;2025-01-05
Deutschland;Berlin Research;Zutrittsverletzung;2025-02-01
Deutschland;Berlin Research;VerdÃ¤chtige Person;2025-02-02
Deutschland;Berlin Research;VerdÃ¤chtige Person;2025-02-04
Deutschland;MÃ¼nchen Warehouse;Diebstahl;2025-03-01
Deutschland;MÃ¼nchen Warehouse;Diebstahl;2025-03-02
Deutschland;MÃ¼nchen Warehouse;Alarmanlage ausgelÃ¶st;2025-03-05
Deutschland;MÃ¼nchen Warehouse;Zutrittsverletzung;2025-03-06
USA;Cambridge Lab;Zutrittsverletzung;2025-01-10
USA;Cambridge Lab;VerdÃ¤chtige Person;2025-01-12
USA;Cambridge Lab;Alarmanlage ausgelÃ¶st;2025-01-15
USA;San Diego Office;VerdÃ¤chtige Person;2025-02-10
USA;San Diego Office;VerdÃ¤chtige Person;2025-02-12
USA;San Diego Office;Diebstahl;2025-02-14
USA;San Diego Office;Zutrittsverletzung;2025-02-16
UK;London HQ;Zutrittsverletzung;2025-01-07
UK;London HQ;Zutrittsverletzung;2025-01-09
UK;London HQ;VerdÃ¤chtige Person;2025-01-11
UK;London HQ;Alarmanlage ausgelÃ¶st;2025-01-13
UK;Reading Plant;Diebstahl;2025-03-03
UK;Reading Plant;Diebstahl;2025-03-06
UK;Reading Plant;Zutrittsverletzung;2025-03-07
Schweiz;Basel Site;VerdÃ¤chtige Person;2025-02-03
Schweiz;Basel Site;VerdÃ¤chtige Person;2025-02-05
Schweiz;Basel Site;Alarmanlage ausgelÃ¶st;2025-02-06
Schweiz;Basel Site;Zutrittsverletzung;2025-02-08
Belgien;BrÃ¼ssel Office;Zutrittsverletzung;2025-01-20
Belgien;BrÃ¼ssel Office;Diebstahl;2025-01-22
Belgien;BrÃ¼ssel Office;Diebstahl;2025-01-23
Belgien;BrÃ¼ssel Office;VerdÃ¤chtige Person;2025-01-25`;
}

// =======================
// EXPORT FUNCTIONS - NEU
// =======================
function exportToCSV() {
    if (!currentData || currentData.length === 0) {
        alert('Keine Daten zum Exportieren vorhanden!');
        return;
    }

    const status = document.getElementById('exportStatus');
    status.style.display = 'block';
    status.textContent = 'CSV wird erstellt...';

    // CSV Header
    const headers = Object.keys(currentData[0]);
    let csvContent = headers.join(',') + '\n';

    // CSV Rows
    currentData.forEach(row => {
        const values = headers.map(header => {
            const value = row[header] || '';
            return `"${value.toString().replace(/"/g, '""')}"`;
        });
        csvContent += values.join(',') + '\n';
    });

    // Download
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
    link.href = URL.createObjectURL(blob);
    link.download = `security-events-${timestamp}.csv`;
    link.click();

    status.textContent = `âœ… CSV exportiert (${currentData.length} DatensÃ¤tze)`;
    setTimeout(() => { status.style.display = 'none'; }, 3000);
}

async function exportToPDF() {
    if (!currentData || currentData.length === 0) {
        alert('Keine Daten zum Exportieren vorhanden!');
        return;
    }

    const status = document.getElementById('exportStatus');
    status.style.display = 'block';
    status.textContent = 'ðŸ“Š PDF Report wird erstellt...';

    try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');

        // Report Header
        pdf.setFontSize(20);
        pdf.text('Security Events Report', 20, 25);
        
        pdf.setFontSize(12);
        const timestamp = new Date().toLocaleDateString('de-DE', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit'
        });
        pdf.text(`Erstellt am: ${timestamp}`, 20, 35);
        pdf.text(`DatensÃ¤tze: ${currentData.length}`, 20, 42);

        let yPosition = 55;

        // KPIs
        pdf.setFontSize(14);
        pdf.text('Kennzahlen:', 20, yPosition);
        yPosition += 10;

        pdf.setFontSize(11);
        const totalEvents = document.getElementById('kpiTotalEvents').textContent;
        const totalCountries = document.getElementById('kpiCountries').textContent;
        const totalSites = document.getElementById('kpiSites').textContent;
        const totalTypes = document.getElementById('kpiTypes').textContent;

        pdf.text(`â€¢ Gesamtzahl Ereignisse: ${totalEvents}`, 25, yPosition);
        pdf.text(`â€¢ LÃ¤nder: ${totalCountries}`, 25, yPosition + 7);
        pdf.text(`â€¢ Liegenschaften: ${totalSites}`, 25, yPosition + 14);
        pdf.text(`â€¢ Ereignisarten: ${totalTypes}`, 25, yPosition + 21);

        yPosition += 35;

        // Charts als Screenshots
        status.textContent = 'ðŸ“¸ Screenshots der Charts werden erstellt...';
        
        // Chart Screenshots
        const charts = ['chartCountries', 'chartSites', 'chartTypes'];
        const chartTitles = ['LÃ¤nder-Verteilung', 'Liegenschaften', 'Ereignisarten'];

        for (let i = 0; i < charts.length; i++) {
            const chartElement = document.getElementById(charts[i]);
            if (chartElement && chartElement.querySelector('canvas')) {
                try {
                    const canvas = await html2canvas(chartElement, {
                        backgroundColor: '#ffffff',
                        scale: 2
                    });
                    
                    const imgData = canvas.toDataURL('image/png');
                    
                    // Neue Seite fÃ¼r jeden Chart auÃŸer dem ersten
                    if (i > 0) {
                        pdf.addPage();
                        yPosition = 25;
                    }
                    
                    pdf.setFontSize(14);
                    pdf.text(chartTitles[i], 20, yPosition);
                    pdf.addImage(imgData, 'PNG', 20, yPosition + 5, 170, 100);
                    yPosition += 110;
                } catch (err) {
                    console.error('Chart screenshot error:', err);
                }
            }
        }

        // Download PDF
        const pdfFilename = `security-report-${timestamp.replace(/[^0-9]/g, '')}.pdf`;
        pdf.save(pdfFilename);

        status.textContent = `âœ… PDF Report erstellt: ${pdfFilename}`;
        setTimeout(() => { status.style.display = 'none'; }, 5000);

    } catch (error) {
        console.error('PDF Error:', error);
        status.textContent = 'âŒ Fehler beim Erstellen des PDF Reports';
        setTimeout(() => { status.style.display = 'none'; }, 3000);
    }
}

// =======================
// CHART FUNCTIONS
// =======================
let chartInstances = {};

function createChart(containerId, data, chartType = 'bar', maxBars = 6) {
    const container = document.getElementById(containerId);
    if (!container) return;

    if (chartInstances[containerId]) {
        chartInstances[containerId].destroy();
        delete chartInstances[containerId];
    }

    container.innerHTML = '';
    
    if (!data || data.length === 0) {
        container.innerHTML = '<div style="padding: 2rem; text-align: center; color: #999;">Keine Daten vorhanden.</div>';
        return;
    }

    const canvas = document.createElement('canvas');
    container.appendChild(canvas);

    const top = data.slice(0, maxBars);
    const labels = top.map(d => d.key || "(leer)");
    const values = top.map(d => d.count);

    const colors = [
        '#00a37a', '#006b4e', '#4caf50', '#8bc34a', 
        '#cddc39', '#ffc107', '#ff9800', '#ff5722'
    ];

    const config = {
        type: chartType,
        data: {
            labels: labels,
            datasets: [{
                label: 'Anzahl Ereignisse',
                data: values,
                backgroundColor: colors.slice(0, values.length).map(color => color + '80'),
                borderColor: colors.slice(0, values.length),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: chartType === 'pie',
                    position: 'bottom'
                }
            },
            scales: chartType === 'pie' ? {} : {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    };

    chartInstances[containerId] = new Chart(canvas, config);
}

// =======================
// MAIN APPLICATION
// =======================
let allData = [];
let currentData = [];
let headerMap = {};
let currentMode = "none";

document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard ready!');

    // DOM Elements
    const loadTestDataBtn = document.getElementById('loadTestData');
    const fileInput = document.getElementById('fileInput');
    const fileStatus = document.getElementById('fileStatus');
    const exportCSVBtn = document.getElementById('exportCSV');
    const exportPDFBtn = document.getElementById('exportPDF');
    
    // Export Event Listeners - NEU
    exportCSVBtn.addEventListener('click', exportToCSV);
    exportPDFBtn.addEventListener('click', exportToPDF);
    
    // Load Test Data
    loadTestDataBtn.addEventListener('click', function() {
        const csv = getTestData();
        const parsed = parseCSV(csv);
        allData = parsed.rows;
        headerMap = createHeaderMap(parsed.headers);
        currentData = allData;
        
        document.getElementById('recordCount').textContent = allData.length.toString();
        document.getElementById('modeIndicator').textContent = 'Modus: Testdaten (Demo)';
        fileStatus.textContent = 'Testdaten sind geladen (Demo-Modus).';
        
        renderAll();
    });
    
    // CSV File Upload
    fileInput.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
            const text = await file.text();
            const parsed = parseCSV(text);
            allData = parsed.rows;
            headerMap = createHeaderMap(parsed.headers);
            currentData = allData;
            
            document.getElementById('recordCount').textContent = allData.length.toString();
            document.getElementById('modeIndicator').textContent = 'Modus: CSV-Datei';
            fileStatus.textContent = `Datei "${file.name}" geladen. DatensÃ¤tze: ${allData.length}.`;
            
            renderAll();
        } catch (err) {
            console.error(err);
            fileStatus.textContent = 'Fehler beim Lesen der Datei.';
        }
    });
    
    function renderAll() {
        renderKPIs();
        renderTables();
        renderCharts();
    }
    
    function renderKPIs() {
        const total = allData.length;
        const current = currentData.length;

        document.getElementById('kpiTotalEvents').textContent = total.toString();
        document.getElementById('kpiTotalEventsSub').textContent = `${current} nach Filter`;

        const countries = new Set();
        const sites = new Set();
        const types = new Set();

        for (const row of allData) {
            if (headerMap.country && row[headerMap.country]) {
                countries.add(row[headerMap.country].trim());
            }
            if (headerMap.site && row[headerMap.site]) {
                sites.add(row[headerMap.site].trim());
            }
            if (headerMap.type && row[headerMap.type]) {
                types.add(row[headerMap.type].trim());
            }
        }

        document.getElementById('kpiCountries').textContent = countries.size.toString();
        document.getElementById('kpiSites').textContent = sites.size.toString();
        document.getElementById('kpiTypes').textContent = types.size.toString();
    }
    
    function renderTables() {
        const tableByCountry = document.querySelector("#tableByCountry tbody");
        const tableBySite = document.querySelector("#tableBySite tbody");
        const tableByType = document.querySelector("#tableByType tbody");
        
        tableByCountry.innerHTML = "";
        tableBySite.innerHTML = "";
        tableByType.innerHTML = "";

        if (currentData.length === 0) return;

        const byCountry = groupAndCount(currentData, row =>
            headerMap.country ? (row[headerMap.country] || "").trim() : ""
        );
        byCountry.forEach(item => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${item.key || "(leer)"}</td>
                <td>${item.count}</td>
            `;
            tableByCountry.appendChild(tr);
        });

        const byType = groupAndCount(currentData, row =>
            headerMap.type ? (row[headerMap.type] || "").trim() : ""
        );
        byType.forEach(item => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${item.key || "(leer)"}</td>
                <td>${item.count}</td>
            `;
            tableByType.appendChild(tr);
        });
    }
    
    function renderCharts() {
        const countries = groupAndCount(currentData, row =>
            headerMap.country ? (row[headerMap.country] || "").trim() : ""
        );
        createChart('chartCountries', countries, 'bar');

        const sites = groupAndCount(currentData, row =>
            headerMap.site ? (row[headerMap.site] || "").trim() : ""
        );
        createChart('chartSites', sites, 'bar');

        const types = groupAndCount(currentData, row =>
            headerMap.type ? (row[headerMap.type] || "").trim() : ""
        );
        createChart('chartTypes', types, 'pie');
    }
});
</script>
</body>
</html>
