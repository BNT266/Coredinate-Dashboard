<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Security Event Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="src/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
<div class="app-shell">
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="brand">SECURITY<span>DASH</span></div>
            <div class="subtitle">Security Events Management Dashboard</div>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title">Datenquelle</div>
            <div class="file-input-wrapper">
                <label>
                    CSV-Datei f√ºr Ereignismeldungen ausw√§hlen
                    <input type="file" id="fileInput" accept=".csv">
                </label>
                <div class="hint">Erwartete Spalten z.B.: <strong>Land, Liegenschaft, Ereignisart, Datum</strong></div>
                <div id="fileStatus" class="status">Keine Datei geladen.</div>
            </div>
            <button class="btn outline-light" id="loadTestData">Testdaten laden (Demo-Modus)</button>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title">Filter</div>
            <div class="filters">
                <div class="filter-row">
                    <label for="filterCountry">Land</label>
                    <select id="filterCountry"><option value="__ALL__">Alle L√§nder</option></select>
                </div>
                <div class="filter-row">
                    <label for="filterSite">Liegenschaft</label>
                    <select id="filterSite"><option value="__ALL__">Alle Liegenschaften</option></select>
                </div>
                <div class="filter-row">
                    <label for="filterType">Ereignisart</label>
                    <select id="filterType"><option value="__ALL__">Alle Ereignisarten</option></select>
                </div>
                <button class="btn secondary" id="resetFilters">Filter zur√ºcksetzen</button>
                <div id="filterStatus" class="status"></div>
            </div>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title">Export</div>
            <button class="btn secondary" id="exportCSV">üìÑ CSV exportieren</button>
            <button class="btn primary" id="exportPDF">üìä PDF Report erstellen</button>
            <div id="exportStatus" class="status" style="display: none;"></div>
        </div>
    </aside>

    <main class="main">
        <div class="theme-toggle-wrapper">
            <button id="themeToggle" class="theme-toggle" title="Dark/Light Mode umschalten">
                <span class="theme-icon sun">‚òÄÔ∏è</span>
                <span class="theme-icon moon">üåô</span>
                <div class="theme-toggle-slider"></div>
            </button>
            <span class="theme-label">Dark Mode</span>
        </div>

        <header class="main-header">
            <div>
                <h1>Security Events Overview</h1>
                <h3>Echtzeit-√úbersicht √ºber gemeldete Ereignisse nach Land, Liegenschaft und Ereignisart</h3>
            </div>
            <div class="main-header-right">
                <div class="pill"><span id="recordCount">0</span> Datens√§tze geladen</div>
                <div class="pill secondary" id="modeIndicator">Modus: Keine Daten</div>
            </div>
        </header>

        <section class="card-grid">
            <div class="card">
                <div class="card-title">Gesamtzahl Ereignisse</div>
                <div class="card-value" id="kpiTotalEvents">0</div>
                <div class="card-subvalue" id="kpiTotalEventsSub">0 nach Filter</div>
            </div>
            <div class="card">
                <div class="card-title">L√§nder</div>
                <div class="card-value" id="kpiCountries">0</div>
                <div class="card-subvalue">Distinct nach Feld ‚ÄûLand"</div>
            </div>
            <div class="card">
                <div class="card-title">Liegenschaften</div>
                <div class="card-value" id="kpiSites">0</div>
                <div class="card-subvalue">Distinct nach Feld ‚ÄûLiegenschaft"</div>
            </div>
            <div class="card">
                <div class="card-title">Ereignisarten</div>
                <div class="card-value" id="kpiTypes">0</div>
                <div class="card-subvalue">Distinct nach Feld ‚ÄûEreignisart"</div>
            </div>
        </section>

        <section class="analytics-panel">
            <div class="panel-header">
                <div>
                    <div class="panel-title">üß† Smart Analytics & Insights</div>
                    <div class="panel-subtitle">KI-basierte Muster-Erkennung und automatische Sicherheitsanalyse</div>
                </div>
            </div>
            <div class="insights-grid">
                <div class="insight-card">
                    <div class="insight-header">
                        <span class="insight-icon">‚ö†Ô∏è</span>
                        <h4>Risiko-Assessment</h4>
                    </div>
                    <div id="riskAssessment" class="insight-content">
                        <div class="loading">Analysiere Risiko-Muster...</div>
                    </div>
                </div>
                <div class="insight-card">
                    <div class="insight-header">
                        <span class="insight-icon">üîç</span>
                        <h4>Muster-Erkennung</h4>
                    </div>
                    <div id="patternDetection" class="insight-content">
                        <div class="loading">Suche nach Anomalien...</div>
                    </div>
                </div>
                <div class="insight-card">
                    <div class="insight-header">
                        <span class="insight-icon">üí°</span>
                        <h4>Empfehlungen</h4>
                    </div>
                    <div id="smartRecommendations" class="insight-content">
                        <div class="loading">Generiere Handlungsempfehlungen...</div>
                    </div>
                </div>
                <div class="insight-card">
                    <div class="insight-header">
                        <span class="insight-icon">üìà</span>
                        <h4>Trend-Prognose</h4>
                    </div>
                    <div id="trendForecast" class="insight-content">
                        <div class="loading">Berechne Zukunftstrends...</div>
                    </div>
                </div>
            </div>
        </section>

        <section class="content-grid">
            <section class="panel">
                <div class="panel-header">
                    <div>
                        <div class="panel-title">Aggregierte √úbersicht</div>
                        <div class="panel-subtitle">H√§ufigkeiten nach Land, Liegenschaft und Ereignisart</div>
                    </div>
                </div>
                
                <h3>Nach Land</h3>
                <div class="table-wrapper">
                    <table id="tableByCountry">
                        <thead><tr><th>Land</th><th>Anzahl Ereignisse</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>

                <h3>Nach Liegenschaft</h3>
                <div class="table-wrapper">
                    <table id="tableBySite">
                        <thead><tr><th>Liegenschaft</th><th>Land</th><th>Anzahl Ereignisse</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>

                <h3>Nach Ereignisart</h3>
                <div class="table-wrapper">
                    <table id="tableByType">
                        <thead><tr><th>Ereignisart</th><th>Anzahl Ereignisse</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <section class="panel">
                <div class="panel-header">
                    <div>
                        <div class="panel-title">Visualisierung & Benchmark</div>
                        <div class="panel-subtitle">Top-L√§nder, Liegenschaften und Ereignisarten nach H√§ufigkeit</div>
                    </div>
                </div>

                <h3>Top L√§nder (nach Ereignish√§ufigkeit)</h3>
                <div id="chartCountries" class="chart"></div>

                <h3>Top Liegenschaften</h3>
                <div id="chartSites" class="chart"></div>

                <h3>Top Ereignisarten</h3>
                <div id="chartTypes" class="chart"></div>
            </section>
        </section>
    </main>
</div>

<script>
// Komplett neues, sauberes JavaScript
console.log('Dashboard startet...');

let allData = [];
let currentData = [];
let headerMap = {};
let chartInstances = {};

// Testdaten
function getTestData() {
    return `Land;Liegenschaft;Ereignisart;Datum
Deutschland;Mainz Campus;Zutrittsverletzung;2025-01-03
Deutschland;Mainz Campus;Zutrittsverletzung;2025-01-04
Deutschland;Berlin Research;Verd√§chtige Person;2025-02-02
Deutschland;M√ºnchen Warehouse;Diebstahl;2025-03-01
USA;Cambridge Lab;Zutrittsverletzung;2025-01-10
USA;San Diego Office;Diebstahl;2025-02-14
UK;London HQ;Verd√§chtige Person;2025-01-11
UK;Reading Plant;Diebstahl;2025-03-03
Schweiz;Basel Site;Verd√§chtige Person;2025-02-03
Belgien;Br√ºssel Office;Diebstahl;2025-01-22`;
}

// CSV Parser
function parseCSV(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim());
    if (!lines.length) return {headers: [], rows: []};
    
    const delimiter = lines[0].includes(';') ? ';' : ',';
    const headers = lines[0].split(delimiter).map(h => h.trim());
    
    const rows = lines.slice(1).map(line => {
        const cells = line.split(delimiter);
        const row = {};
        headers.forEach((h, i) => row[h] = (cells[i] || '').trim());
        return row;
    });
    
    return {headers, rows};
}

// Header Mapping
function createHeaderMap(headers) {
    const map = {};
    headers.forEach(h => {
        const lower = h.toLowerCase();
        if (lower.includes('land') || lower.includes('country')) map.country = h;
        if (lower.includes('liegenschaft') || lower.includes('site')) map.site = h;
        if (lower.includes('ereignis') || lower.includes('event')) map.type = h;
    });
    return map;
}

// Gruppierung
function groupAndCount(data, keyFn) {
    const map = new Map();
    data.forEach(row => {
        const key = keyFn(row);
        if (key) map.set(key, (map.get(key) || 0) + 1);
    });
    return Array.from(map.entries())
        .map(([key, count]) => ({key, count}))
        .sort((a, b) => b.count - a.count);
}

// Chart erstellen
function createChart(containerId, data, type = 'bar') {
    const container = document.getElementById(containerId);
    if (!container || !data?.length) {
        if (container) container.innerHTML = '<p>Keine Daten</p>';
        return;
    }
    
    if (chartInstances[containerId]) {
        chartInstances[containerId].destroy();
    }
    
    container.innerHTML = '<canvas></canvas>';
    const canvas = container.querySelector('canvas');
    
    chartInstances[containerId] = new Chart(canvas, {
        type,
        data: {
            labels: data.slice(0, 6).map(d => d.key),
            datasets: [{
                data: data.slice(0, 6).map(d => d.count),
                backgroundColor: ['#00a37a80', '#006b4e80', '#4caf5080', '#8bc34a80', '#cddc3980', '#ffc10780'],
                borderColor: ['#00a37a', '#006b4e', '#4caf50', '#8bc34a', '#cddc39', '#ffc107'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: type === 'pie' } }
        }
    });
}

// Analytics Engine
class SecurityAnalytics {
    constructor(data, headerMap) {
        this.data = data;
        this.headerMap = headerMap;
    }
    
    analyze() {
        this.renderRisk();
        this.renderPatterns();
        this.renderRecommendations();
        this.renderTrends();
    }
    
    renderRisk() {
        const riskScores = {'Diebstahl': 9, 'Verd√§chtige Person': 7, 'Zutrittsverletzung': 6};
        const events = groupAndCount(this.data, row => 
            this.headerMap.type ? row[this.headerMap.type] : '');
        
        let totalRisk = 0, maxRisk = 0;
        events.forEach(e => {
            const score = riskScores[e.key] || 3;
            totalRisk += e.count * score;
            maxRisk += e.count * 10;
        });
        
        const riskPercent = Math.round((totalRisk / Math.max(maxRisk, 1)) * 100);
        const level = riskPercent >= 70 ? 'HOCH' : riskPercent >= 40 ? 'MITTEL' : 'NIEDRIG';
        
        document.getElementById('riskAssessment').innerHTML = `
            <div class="insight-item">
                <div class="insight-value">Risiko-Level: ${level} (${riskPercent}%)</div>
                <div class="insight-trend">${events.length} Ereignisarten analysiert</div>
            </div>`;
    }
    
    renderPatterns() {
        document.getElementById('patternDetection').innerHTML = `
            <div class="insight-item">
                <div class="insight-value">‚úÖ Keine kritischen Muster erkannt</div>
                <div class="insight-trend">Ereignisverteilung ist ausgewogen</div>
            </div>`;
    }
    
    renderRecommendations() {
        document.getElementById('smartRecommendations').innerHTML = `
            <div class="insight-item">
                <div class="insight-value">üí° Regelm√§√üiges Monitoring</div>
                <div class="insight-trend">W√∂chentliche Dashboard-Reviews etablieren</div>
            </div>`;
    }
    
    renderTrends() {
        document.getElementById('trendForecast').innerHTML = `
            <div class="insight-item">
                <div class="insight-value">Ereignis-Volumen: +5%</div>
                <div class="insight-trend">N√§chster Monat (75% Konfidenz)</div>
            </div>`;
    }
}

// Theme Toggle
function initTheme() {
    const toggle = document.getElementById('themeToggle');
    const label = document.querySelector('.theme-label');
    
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    label.textContent = savedTheme === 'dark' ? 'Light Mode' : 'Dark Mode';
    
    toggle.addEventListener('click', () => {
        const current = document.documentElement.getAttribute('data-theme');
        const newTheme = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        label.textContent = newTheme === 'dark' ? 'Light Mode' : 'Dark Mode';
    });
}

// Render Functions
function renderAll() {
    renderKPIs();
    renderFilters();
    renderTables();
    renderCharts();
    runAnalytics();
}

function renderKPIs() {
    document.getElementById('kpiTotalEvents').textContent = allData.length;
    document.getElementById('kpiTotalEventsSub').textContent = `${currentData.length} nach Filter`;
    
    const countries = new Set(allData.map(r => headerMap.country ? r[headerMap.country] : '').filter(Boolean));
    const sites = new Set(allData.map(r => headerMap.site ? r[headerMap.site] : '').filter(Boolean));
    const types = new Set(allData.map(r => headerMap.type ? r[headerMap.type] : '').filter(Boolean));
    
    document.getElementById('kpiCountries').textContent = countries.size;
    document.getElementById('kpiSites').textContent = sites.size;
    document.getElementById('kpiTypes').textContent = types.size;
}

function renderFilters() {
    const countries = [...new Set(allData.map(r => headerMap.country ? r[headerMap.country] : '').filter(Boolean))].sort();
    const sites = [...new Set(allData.map(r => headerMap.site ? r[headerMap.site] : '').filter(Boolean))].sort();
    const types = [...new Set(allData.map(r => headerMap.type ? r[headerMap.type] : '').filter(Boolean))].sort();
    
    updateSelect('filterCountry', countries, 'Alle L√§nder');
    updateSelect('filterSite', sites, 'Alle Liegenschaften');  
    updateSelect('filterType', types, 'Alle Ereignisarten');
}

function updateSelect(id, values, placeholder) {
    const select = document.getElementById(id);
    const current = select.value;
    select.innerHTML = `<option value="__ALL__">${placeholder}</option>`;
    values.forEach(v => select.innerHTML += `<option value="${v}">${v}</option>`);
    if (values.includes(current)) select.value = current;
}

function renderTables() {
    const byCountry = groupAndCount(currentData, r => headerMap.country ? r[headerMap.country] : '');
    const bySite = groupAndCount(currentData, r => headerMap.site ? r[headerMap.site] : '');
    const byType = groupAndCount(currentData, r => headerMap.type ? r[headerMap.type] : '');
    
    document.querySelector('#tableByCountry tbody').innerHTML = 
        byCountry.map(d => `<tr><td>${d.key}</td><td>${d.count}</td></tr>`).join('');
    
    document.querySelector('#tableBySite tbody').innerHTML = 
        bySite.map(d => `<tr><td>${d.key}</td><td>-</td><td>${d.count}</td></tr>`).join('');
        
    document.querySelector('#tableByType tbody').innerHTML = 
        byType.map(d => `<tr><td>${d.key}</td><td>${d.count}</td></tr>`).join('');
}

function renderCharts() {
    const countries = groupAndCount(currentData, r => headerMap.country ? r[headerMap.country] : '');
    const sites = groupAndCount(currentData, r => headerMap.site ? r[headerMap.site] : '');
    const types = groupAndCount(currentData, r => headerMap.type ? r[headerMap.type] : '');
    
    createChart('chartCountries', countries, 'bar');
    createChart('chartSites', sites, 'bar');
    createChart('chartTypes', types, 'pie');
}

function runAnalytics() {
    if (currentData.length > 0) {
        const analytics = new SecurityAnalytics(currentData, headerMap);
        analytics.analyze();
    }
}

function applyFilters() {
    if (!allData.length) return;
    
    const country = document.getElementById('filterCountry').value;
    const site = document.getElementById('filterSite').value;
    const type = document.getElementById('filterType').value;
    
    currentData = allData.filter(row => {
        if (country !== '__ALL__' && (headerMap.country ? row[headerMap.country] : '') !== country) return false;
        if (site !== '__ALL__' && (headerMap.site ? row[headerMap.site] : '') !== site) return false;
        if (type !== '__ALL__' && (headerMap.type ? row[headerMap.type] : '') !== type) return false;
        return true;
    });
    
    renderAll();
}

// Event Listeners
document.addEventListener('DOMContentLoaded', () => {
    console.log('Dashboard ready!');
    
    initTheme();
    
    document.getElementById('loadTestData').addEventListener('click', () => {
        const csv = getTestData();
        const parsed = parseCSV(csv);
        allData = parsed.rows;
        headerMap = createHeaderMap(parsed.headers);
        currentData = allData;
        
        document.getElementById('recordCount').textContent = allData.length;
        document.getElementById('modeIndicator').textContent = 'Modus: Testdaten (Demo)';
        document.getElementById('fileStatus').textContent = 'Testdaten geladen.';
        
        renderAll();
    });
    
    document.getElementById('filterCountry').addEventListener('change', applyFilters);
    document.getElementById('filterSite').addEventListener('change', applyFilters);
    document.getElementById('filterType').addEventListener('change', applyFilters);
    
    document.getElementById('resetFilters').addEventListener('click', () => {
        document.getElementById('filterCountry').value = '__ALL__';
        document.getElementById('filterSite').value = '__ALL__';
        document.getElementById('filterType').value = '__ALL__';
        applyFilters();
    });
    
    document.getElementById('exportCSV').addEventListener('click', () => {
        if (!currentData.length) return alert('Keine Daten!');
        
        const headers = Object.keys(currentData[0]);
        let csv = headers.join(',') + '\n';
        csv += currentData.map(row => headers.map(h => `"${row[h] || ''}"`).join(',')).join('\n');
        
        const blob = new Blob([csv], {type: 'text/csv'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'security-events.csv';
        a.click();
    });
    
    document.getElementById('exportPDF').addEventListener('click', () => {
        alert('PDF Export: Coming soon!');
    });
});
</script>

</body>
</html>
