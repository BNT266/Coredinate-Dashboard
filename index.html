<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <title>Security Event Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- External CSS -->
    <link rel="stylesheet" href="src/css/styles.css">
    
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- PDF Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
<div class="app-shell">
    <!-- ========== SIDEBAR ========== -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="brand">SECURITY<span>DASH</span></div>
            <div class="subtitle">Security Events Management Dashboard</div>
        </div>

        <!-- CSV Upload & Testmodus -->
        <div class="sidebar-section">
            <div class="sidebar-section-title">Datenquelle</div>

            <div class="file-input-wrapper">
                <label>
                    CSV-Datei f√ºr Ereignismeldungen ausw√§hlen
                    <input type="file" id="fileInput" accept=".csv" />
                </label>
                <div class="hint">
                    Erwartete Spalten z.B.: <strong>Land, Liegenschaft, Ereignisart, Datum</strong>
                </div>
                <div id="fileStatus" class="status">Keine Datei geladen.</div>
            </div>

            <button class="btn outline-light" id="loadTestData">
                Testdaten laden (Demo-Modus)
            </button>
            <div class="hint">
                Nutze den Testmodus, um das Dashboard ohne eigene CSV-Datei auszuprobieren.
            </div>
        </div>

        <!-- Filter -->
        <div class="sidebar-section">
            <div class="sidebar-section-title">Filter</div>
            <div class="filters">
                <div class="filter-row">
                    <label for="filterCountry">Land</label>
                    <select id="filterCountry">
                        <option value="__ALL__">Alle L√§nder</option>
                    </select>
                </div>
                <div class="filter-row">
                    <label for="filterSite">Liegenschaft</label>
                    <select id="filterSite">
                        <option value="__ALL__">Alle Liegenschaften</option>
                    </select>
                </div>
                <div class="filter-row">
                    <label for="filterType">Ereignisart</label>
                    <select id="filterType">
                        <option value="__ALL__">Alle Ereignisarten</option>
                    </select>
                </div>
                <button class="btn secondary" id="resetFilters">Filter zur√ºcksetzen</button>
                <div id="filterStatus" class="status"></div>
            </div>
        </div>

        <!-- Export Section -->
        <div class="sidebar-section">
            <div class="sidebar-section-title">Export</div>
            
            <button class="btn secondary" id="exportCSV">
                üìÑ CSV exportieren
            </button>
            <div class="hint">
                Exportiert die aktuell gefilterten Daten als CSV-Datei.
            </div>

            <button class="btn primary" id="exportPDF">
                üìä PDF Report erstellen
            </button>
            <div class="hint">
                Erstellt einen professionellen PDF-Report mit allen Charts und Tabellen.
            </div>
            
            <div id="exportStatus" class="status" style="display: none;"></div>
        </div>
    </aside>

    <!-- ========== MAIN CONTENT ========== -->
    <main class="main">
        <!-- ========== MAIN CONTENT ========== -->
    <main class="main">
        
        <!-- ===== THEME TOGGLE - NEU ===== -->
        <div class="theme-toggle-wrapper">
            <button id="themeToggle" class="theme-toggle" title="Dark/Light Mode umschalten">
                <span class="theme-icon sun">‚òÄÔ∏è</span>
                <span class="theme-icon moon">üåô</span>
                <div class="theme-toggle-slider"></div>
            </button>
            <span class="theme-label">Dark Mode</span>
        </div>
        
        <!-- Header -->
        <header class="main-header">
        <!-- Header -->
        <header class="main-header">
            <div>
                <h1>Security Events Overview</h1>
                <h3>Echtzeit-√úbersicht √ºber gemeldete Ereignisse nach Land, Liegenschaft und Ereignisart</h3>
            </div>
            <div class="main-header-right">
                <div class="pill">
                    <span id="recordCount">0</span> Datens√§tze geladen
                </div>
                <div class="pill secondary" id="modeIndicator">
                    Modus: Keine Daten
                </div>
            </div>
        </header>

        <!-- KPI Cards -->
        <section class="card-grid" aria-label="Kennzahlen">
            <div class="card">
                <div class="card-title">Gesamtzahl Ereignisse</div>
                <div class="card-value" id="kpiTotalEvents">0</div>
                <div class="card-subvalue" id="kpiTotalEventsSub">0 nach Filter</div>
            </div>
            <div class="card">
                <div class="card-title">L√§nder</div>
                <div class="card-value" id="kpiCountries">0</div>
                <div class="card-subvalue">Distinct nach Feld ‚ÄûLand"</div>
            </div>
            <div class="card">
                <div class="card-title">Liegenschaften</div>
                <div class="card-value" id="kpiSites">0</div>
                <div class="card-subvalue">Distinct nach Feld ‚ÄûLiegenschaft"</div>
            </div>
            <div class="card">
                <div class="card-title">Ereignisarten</div>
                <div class="card-value" id="kpiTypes">0</div>
                <div class="card-subvalue">Distinct nach Feld ‚ÄûEreignisart"</div>
            </div>
        </section>
</section>

        <!-- ===== HIER EINF√úGEN (neue Zeilen) ===== -->
        <section class="analytics-panel">
            <div class="panel-header">
                <div>
                    <div class="panel-title">üß† Smart Analytics & Insights</div>
                    <div class="panel-subtitle">
                        KI-basierte Muster-Erkennung und automatische Sicherheitsanalyse
                    </div>
                </div>
            </div>

            <div class="insights-grid">
                <!-- Risk Assessment -->
                <div class="insight-card">
                    <div class="insight-header">
                        <span class="insight-icon">‚ö†Ô∏è</span>
                        <h4>Risiko-Assessment</h4>
                    </div>
                    <div id="riskAssessment" class="insight-content">
                        <div class="loading">Analysiere Risiko-Muster...</div>
                    </div>
                </div>

                <!-- Pattern Detection -->
                <div class="insight-card">
                    <div class="insight-header">
                        <span class="insight-icon">üîç</span>
                        <h4>Muster-Erkennung</h4>
                    </div>
                    <div id="patternDetection" class="insight-content">
                        <div class="loading">Suche nach Anomalien...</div>
                    </div>
                </div>

                <!-- Smart Recommendations -->
                <div class="insight-card">
                    <div class="insight-header">
                        <span class="insight-icon">üí°</span>
                        <h4>Empfehlungen</h4>
                    </div>
                    <div id="smartRecommendations" class="insight-content">
                        <div class="loading">Generiere Handlungsempfehlungen...</div>
                    </div>
                </div>

                <!-- Trend Forecast -->
                <div class="insight-card">
                    <div class="insight-header">
                        <span class="insight-icon">üìà</span>
                        <h4>Trend-Prognose</h4>
                    </div>
                    <div id="trendForecast" class="insight-content">
                        <div class="loading">Berechne Zukunftstrends...</div>
                    </div>
                </div>
            </div>
        </section>
        <!-- ===== BIS HIER ===== -->

        <!-- Grids -->
        <section class="content-grid">
        <!-- Grids -->
        <section class="content-grid">
            <!-- Left: Tables -->
            <section class="panel" aria-label="Tabellarische Auswertung">
                <div class="panel-header">
                    <div>
                        <div class="panel-title">Aggregierte √úbersicht</div>
                        <div class="panel-subtitle">
                            H√§ufigkeiten nach Land, Liegenschaft und Ereignisart (inkl. aktiver Filter)
                        </div>
                    </div>
                </div>

                <h3>Nach Land</h3>
                <div class="table-wrapper">
                    <table id="tableByCountry">
                        <thead>
                        <tr>
                            <th>Land</th>
                            <th>Anzahl Ereignisse</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <h3>Nach Liegenschaft</h3>
                <div class="table-wrapper">
                    <table id="tableBySite">
                        <thead>
                        <tr>
                            <th>Liegenschaft</th>
                            <th>Land</th>
                            <th>Anzahl Ereignisse</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <h3>Nach Ereignisart</h3>
                <div class="table-wrapper">
                    <table id="tableByType">
                        <thead>
                        <tr>
                            <th>Ereignisart</th>
                            <th>Anzahl Ereignisse</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- Right: Charts & Benchmarks -->
            <section class="panel" aria-label="Visualisierung">
                <div class="panel-header">
                    <div>
                        <div class="panel-title">Visualisierung & Benchmark</div>
                        <div class="panel-subtitle">
                            Top-L√§nder, Liegenschaften und Ereignisarten nach H√§ufigkeit
                        </div>
                    </div>
                </div>

                <h3>Top L√§nder (nach Ereignish√§ufigkeit)</h3>
                <div id="chartCountries" class="chart"></div>

                <h3>Top Liegenschaften</h3>
                <div id="chartSites" class="chart"></div>

                <h3>Top Ereignisarten</h3>
                <div id="chartTypes" class="chart"></div>
            </section>
        </section>
    </main>
</div>

<!-- JavaScript direkt in HTML - funktioniert garantiert -->
<script>
console.log('Dashboard startet...');

// =======================
// UTILITY FUNCTIONS
// =======================
function parseCSV(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
    if (lines.length === 0) return [];

    const delimiter = detectDelimiter(lines[0]);
    const headers = lines[0].split(delimiter).map(h => h.trim());

    const rows = [];
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        const cells = splitCSVLine(line, delimiter);
        if (cells.length === 1 && cells[0] === "") continue;
        const row = {};
        headers.forEach((h, idx) => {
            row[h] = (cells[idx] || "").trim();
        });
        rows.push(row);
    }
    return { headers, rows };
}

function detectDelimiter(headerLine) {
    const candidates = [",", ";", "\t"];
    let best = ",";
    let bestCount = 0;
    for (const d of candidates) {
        const count = headerLine.split(d).length;
        if (count > bestCount) {
            bestCount = count;
            best = d;
        }
    }
    return best;
}

function splitCSVLine(line, delimiter) {
    const result = [];
    let current = "";
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
        const c = line[i];
        if (c === '"') {
            inQuotes = !inQuotes;
            continue;
        }
        if (c === delimiter && !inQuotes) {
            result.push(current);
            current = "";
        } else {
            current += c;
        }
    }
    result.push(current);
    return result;
}

function createHeaderMap(headers) {
    const normalize = (s) =>
        s.toLowerCase()
            .replace(/\s+/g, "")
            .replace(/√ü/g, "ss")
            .replace(/[^a-z0-9]/g, "");

    const map = {};
    const targetNames = {
        country: ["land", "country"],
        site: ["liegenschaft", "site", "standort"],
        type: ["ereignisart", "ereignissart", "eventtype", "ereignis"]
    };

    const normalized = headers.map(h => ({ header: h, norm: normalize(h) }));

    for (const n of normalized) {
        const val = n.norm;
        if (targetNames.country.some(t => val.includes(t))) {
            map.country = n.header;
        }
        if (targetNames.site.some(t => val.includes(t))) {
            map.site = n.header;
        }
        if (targetNames.type.some(t => val.includes(t))) {
            map.type = n.header;
        }
    }

    return map;
}

function groupAndCount(rows, keyFn) {
    const map = new Map();
    for (const row of rows) {
        const key = keyFn(row);
        if (!key) continue;
        map.set(key, (map.get(key) || 0) + 1);
    }
    return Array.from(map.entries())
        .map(([key, count]) => ({ key, count }))
        .sort((a, b) => b.count - a.count);
}

function getTestData() {
    return `Land;Liegenschaft;Ereignisart;Datum
Deutschland;Mainz Campus;Zutrittsverletzung;2025-01-03
Deutschland;Mainz Campus;Zutrittsverletzung;2025-01-04
Deutschland;Mainz Campus;Alarmanlage ausgel√∂st;2025-01-05
Deutschland;Berlin Research;Zutrittsverletzung;2025-02-01
Deutschland;Berlin Research;Verd√§chtige Person;2025-02-02
Deutschland;Berlin Research;Verd√§chtige Person;2025-02-04
Deutschland;M√ºnchen Warehouse;Diebstahl;2025-03-01
Deutschland;M√ºnchen Warehouse;Diebstahl;2025-03-02
Deutschland;M√ºnchen Warehouse;Alarmanlage ausgel√∂st;2025-03-05
Deutschland;M√ºnchen Warehouse;Zutrittsverletzung;2025-03-06
USA;Cambridge Lab;Zutrittsverletzung;2025-01-10
USA;Cambridge Lab;Verd√§chtige Person;2025-01-12
USA;Cambridge Lab;Alarmanlage ausgel√∂st;2025-01-15
USA;San Diego Office;Verd√§chtige Person;2025-02-10
USA;San Diego Office;Verd√§chtige Person;2025-02-12
USA;San Diego Office;Diebstahl;2025-02-14
USA;San Diego Office;Zutrittsverletzung;2025-02-16
UK;London HQ;Zutrittsverletzung;2025-01-07
UK;London HQ;Zutrittsverletzung;2025-01-09
UK;London HQ;Verd√§chtige Person;2025-01-11
UK;London HQ;Alarmanlage ausgel√∂st;2025-01-13
UK;Reading Plant;Diebstahl;2025-03-03
UK;Reading Plant;Diebstahl;2025-03-06
UK;Reading Plant;Zutrittsverletzung;2025-03-07
Schweiz;Basel Site;Verd√§chtige Person;2025-02-03
Schweiz;Basel Site;Verd√§chtige Person;2025-02-05
Schweiz;Basel Site;Alarmanlage ausgel√∂st;2025-02-06
Schweiz;Basel Site;Zutrittsverletzung;2025-02-08
Belgien;Br√ºssel Office;Zutrittsverletzung;2025-01-20
Belgien;Br√ºssel Office;Diebstahl;2025-01-22
Belgien;Br√ºssel Office;Diebstahl;2025-01-23
Belgien;Br√ºssel Office;Verd√§chtige Person;2025-01-25`;
}

// =======================
// EXPORT FUNCTIONS - NEU
// =======================
function exportToCSV() {
    if (!currentData || currentData.length === 0) {
        alert('Keine Daten zum Exportieren vorhanden!');
        return;
    }

    const status = document.getElementById('exportStatus');
    status.style.display = 'block';
    status.textContent = 'CSV wird erstellt...';

    // CSV Header
    const headers = Object.keys(currentData[0]);
    let csvContent = headers.join(',') + '\n';

    // CSV Rows
    currentData.forEach(row => {
        const values = headers.map(header => {
            const value = row[header] || '';
            return `"${value.toString().replace(/"/g, '""')}"`;
        });
        csvContent += values.join(',') + '\n';
    });

    // Download
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
    link.href = URL.createObjectURL(blob);
    link.download = `security-events-${timestamp}.csv`;
    link.click();

    status.textContent = `‚úÖ CSV exportiert (${currentData.length} Datens√§tze)`;
    setTimeout(() => { status.style.display = 'none'; }, 3000);
}

async function exportToPDF() {
    if (!currentData || currentData.length === 0) {
        alert('Keine Daten zum Exportieren vorhanden!');
        return;
    }

    const status = document.getElementById('exportStatus');
    status.style.display = 'block';
    status.textContent = 'üé® Professioneller PDF Report wird erstellt...';

    try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();

        // ===== SEITE 1: EXECUTIVE SUMMARY =====
        
        // Header mit Corporate Design
        pdf.setFillColor(0, 163, 122); // #00a37a
        pdf.rect(0, 0, pageWidth, 30, 'F');
        
        // Logo/Brand Area
        pdf.setTextColor(255, 255, 255);
        pdf.setFontSize(24);
        pdf.text('SECURITY DASHBOARD', 20, 20);
        
        pdf.setFontSize(12);
        pdf.text('Professional Security Events Report', 20, 26);

        // Report Info
        pdf.setTextColor(0, 0, 0);
        pdf.setFontSize(14);
        pdf.text('Executive Summary', 20, 45);
        
        const timestamp = new Date().toLocaleDateString('de-DE', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit'
        });
        
        pdf.setFontSize(10);
        pdf.setTextColor(100, 100, 100);
        pdf.text(`Bericht erstellt am: ${timestamp}`, 20, 52);
        pdf.text(`Datenstand: $${allData.length} Gesamtereignisse, $${currentData.length} analysiert`, 20, 57);

        // KPI Cards Design
        let yPos = 70;
        
        // KPI Card 1
        pdf.setFillColor(245, 245, 245);
        pdf.rect(20, yPos, 40, 25, 'F');
        pdf.setTextColor(0, 163, 122);
        pdf.setFontSize(20);
        const totalEvents = document.getElementById('kpiTotalEvents').textContent;
        pdf.text(totalEvents, 25, yPos + 15);
        pdf.setFontSize(8);
        pdf.setTextColor(0, 0, 0);
        pdf.text('Ereignisse', 25, yPos + 20);

        // KPI Card 2
        pdf.setFillColor(245, 245, 245);
        pdf.rect(70, yPos, 40, 25, 'F');
        pdf.setTextColor(0, 163, 122);
        pdf.setFontSize(20);
        const totalCountries = document.getElementById('kpiCountries').textContent;
        pdf.text(totalCountries, 75, yPos + 15);
        pdf.setFontSize(8);
        pdf.setTextColor(0, 0, 0);
        pdf.text('L√§nder', 75, yPos + 20);

        // KPI Card 3
        pdf.setFillColor(245, 245, 245);
        pdf.rect(120, yPos, 40, 25, 'F');
        pdf.setTextColor(0, 163, 122);
        pdf.setFontSize(20);
        const totalSites = document.getElementById('kpiSites').textContent;
        pdf.text(totalSites, 125, yPos + 15);
        pdf.setFontSize(8);
        pdf.setTextColor(0, 0, 0);
        pdf.text('Standorte', 125, yPos + 20);

        yPos += 35;

        // Top Events Tabelle
        pdf.setFontSize(12);
        pdf.setTextColor(0, 0, 0);
        pdf.text('Top Ereignisarten:', 20, yPos);
        yPos += 10;

        const byType = groupAndCount(currentData, row =>
            headerMap.type ? (row[headerMap.type] || "").trim() : ""
        );

        pdf.setFontSize(9);
        byType.slice(0, 8).forEach((item, index) => {
            const barWidth = (item.count / byType[0].count) * 100;
            
            // Bar
            pdf.setFillColor(0, 163, 122);
            pdf.rect(20, yPos, barWidth * 0.8, 4, 'F');
            
            // Label und Count
            pdf.setTextColor(0, 0, 0);
            pdf.text(`${item.key || "(leer)"}`, 22, yPos + 3);
            pdf.text(`${item.count}`, 130, yPos + 3);
            yPos += 8;
        });

        yPos += 10;

        // Top L√§nder
        pdf.setFontSize(12);
        pdf.text('Verteilung nach L√§ndern:', 20, yPos);
        yPos += 10;

        const byCountry = groupAndCount(currentData, row =>
            headerMap.country ? (row[headerMap.country] || "").trim() : ""
        );

        pdf.setFontSize(9);
        byCountry.slice(0, 5).forEach((item, index) => {
            const barWidth = (item.count / byCountry[0].count) * 100;
            
            pdf.setFillColor(0, 107, 78); // Darker green
            pdf.rect(20, yPos, barWidth * 0.8, 4, 'F');
            
            pdf.setTextColor(0, 0, 0);
            pdf.text(`${item.key || "(leer)"}`, 22, yPos + 3);
            pdf.text(`${item.count}`, 130, yPos + 3);
            yPos += 8;
        });

        // ===== SEITE 2: DETAILLIERTE CHARTS =====
        pdf.addPage();
        
        // Header f√ºr Seite 2
        pdf.setFillColor(0, 163, 122);
        pdf.rect(0, 0, pageWidth, 25, 'F');
        pdf.setTextColor(255, 255, 255);
        pdf.setFontSize(16);
        pdf.text('Detaillierte Analyse & Visualisierungen', 20, 17);

        status.textContent = 'üìä Chart-Screenshots werden erstellt...';

        yPos = 40;

        // Charts Screenshots mit besserer Qualit√§t
        const chartConfigs = [
            { id: 'chartCountries', title: 'Ereignisse nach L√§ndern', height: 60 },
            { id: 'chartTypes', title: 'Verteilung der Ereignisarten', height: 60 },
            { id: 'chartSites', title: 'Ereignisse nach Standorten', height: 60 }
        ];

        for (let i = 0; i < chartConfigs.length; i++) {
            const config = chartConfigs[i];
            const chartElement = document.getElementById(config.id);
            
            if (chartElement && chartElement.querySelector('canvas')) {
                try {
                    const canvas = await html2canvas(chartElement, {
                        backgroundColor: '#ffffff',
                        scale: 2,
                        logging: false,
                        useCORS: true,
                        allowTaint: false
                    });
                    
                    const imgData = canvas.toDataURL('image/png', 1.0);
                    
                    // Neue Seite wenn n√∂tig
                    if (yPos > pageHeight - 70) {
                        pdf.addPage();
                        pdf.setFillColor(0, 163, 122);
                        pdf.rect(0, 0, pageWidth, 25, 'F');
                        pdf.setTextColor(255, 255, 255);
                        pdf.setFontSize(16);
                        pdf.text('Detaillierte Analyse (Fortsetzung)', 20, 17);
                        yPos = 40;
                    }
                    
                    // Chart Title
                    pdf.setTextColor(0, 0, 0);
                    pdf.setFontSize(12);
                    pdf.text(config.title, 20, yPos);
                    
                    // Chart Image
                    pdf.addImage(imgData, 'PNG', 20, yPos + 5, 170, config.height);
                    yPos += config.height + 15;
                    
                } catch (err) {
                    console.error(`Chart ${config.id} screenshot error:`, err);
                    pdf.setTextColor(200, 0, 0);
                    pdf.text(`‚ö† Chart konnte nicht geladen werden`, 20, yPos);
                    yPos += 10;
                }
            }
        }

        // ===== SEITE 3: TABELLEN UND DETAILS =====
        pdf.addPage();
        
        pdf.setFillColor(0, 163, 122);
        pdf.rect(0, 0, pageWidth, 25, 'F');
        pdf.setTextColor(255, 255, 255);
        pdf.setFontSize(16);
        pdf.text('Detaillierte Tabellen', 20, 17);

        yPos = 35;

        // Tabelle: Top Ereignisarten
        pdf.setTextColor(0, 0, 0);
        pdf.setFontSize(12);
        pdf.text('Ereignisarten (Detailansicht):', 20, yPos);
        yPos += 10;

        // Tabellen-Header
        pdf.setFillColor(240, 240, 240);
        pdf.rect(20, yPos, 170, 7, 'F');
        pdf.setFontSize(9);
        pdf.text('Ereignisart', 22, yPos + 5);
        pdf.text('Anzahl', 140, yPos + 5);
        pdf.text('Anteil', 160, yPos + 5);
        yPos += 10;

        // Tabellen-Daten
        const totalEvents2 = currentData.length;
        byType.forEach((item, index) => {
            if (index < 15 && yPos < pageHeight - 20) {
                const percentage = ((item.count / totalEvents2) * 100).toFixed(1);
                
                pdf.setTextColor(0, 0, 0);
                pdf.text(`${item.key || "(leer)"}`, 22, yPos);
                pdf.text(`${item.count}`, 140, yPos);
                pdf.text(`${percentage}%`, 160, yPos);
                yPos += 6;
            }
        });

        yPos += 10;

        // Footer
        pdf.setTextColor(100, 100, 100);
        pdf.setFontSize(8);
        pdf.text(`Generiert von Security Dashboard ‚Ä¢ ${timestamp} ‚Ä¢ Seite 3 von 3`, 20, pageHeight - 10);

        // Download
        const pdfFilename = `security-events-report-${new Date().toISOString().slice(0, 10)}.pdf`;
        pdf.save(pdfFilename);

        status.textContent = `‚úÖ Professional PDF Report erstellt: ${pdfFilename}`;
        setTimeout(() => { status.style.display = 'none'; }, 5000);

    } catch (error) {
        console.error('PDF Error:', error);
        status.textContent = '‚ùå Fehler beim Erstellen des PDF Reports';
        setTimeout(() => { status.style.display = 'none'; }, 3000);
    }
}

// =======================
// CHART FUNCTIONS
// =======================
let chartInstances = {};

function createChart(containerId, data, chartType = 'bar', maxBars = 6) {
    const container = document.getElementById(containerId);
    if (!container) return;

    if (chartInstances[containerId]) {
        chartInstances[containerId].destroy();
        delete chartInstances[containerId];
    }

    container.innerHTML = '';
    
    if (!data || data.length === 0) {
        container.innerHTML = '<div style="padding: 2rem; text-align: center; color: #999;">Keine Daten vorhanden.</div>';
        return;
    }

    const canvas = document.createElement('canvas');
    container.appendChild(canvas);

    const top = data.slice(0, maxBars);
    const labels = top.map(d => d.key || "(leer)");
    const values = top.map(d => d.count);

    const colors = [
        '#00a37a', '#006b4e', '#4caf50', '#8bc34a', 
        '#cddc39', '#ffc107', '#ff9800', '#ff5722'
    ];

    const config = {
        type: chartType,
        data: {
            labels: labels,
            datasets: [{
                label: 'Anzahl Ereignisse',
                data: values,
                backgroundColor: colors.slice(0, values.length).map(color => color + '80'),
                borderColor: colors.slice(0, values.length),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: chartType === 'pie',
                    position: 'bottom'
                }
            },
            scales: chartType === 'pie' ? {} : {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    };

    chartInstances[containerId] = new Chart(canvas, config);
}

// =======================
// MAIN APPLICATION
// =======================
let allData = [];
let currentData = [];
let headerMap = {};
let currentMode = "none";

document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard ready!');
// =======================
// SMART ANALYTICS ENGINE üß†
// =======================

class SecurityAnalytics {
    constructor(data, headerMap) {
        this.data = data;
        this.headerMap = headerMap;
        this.insights = {};
    }

    // Haupt-Analyse-Funktion
    analyzeAll() {
        this.calculateRiskAssessment();
        this.detectPatterns();
        this.generateRecommendations();
        this.forecastTrends();
        this.renderInsights();
    }

    // 1. RISIKO-ASSESSMENT
    calculateRiskAssessment() {
        const riskWeights = {
            'Diebstahl': 9,
            'Verd√§chtige Person': 7,
            'Zutrittsverletzung': 6,
            'Alarmanlage ausgel√∂st': 5,
            'Vandalismus': 8,
            'Einbruch': 10,
            'Brandschutz': 9
        };

        const eventsByType = groupAndCount(this.data, row =>
            this.headerMap.type ? (row[this.headerMap.type] || "").trim() : ""
        );

        let totalRiskScore = 0;
        let maxPossibleScore = 0;
        let highRiskEvents = 0;

        eventsByType.forEach(event => {
            const weight = riskWeights[event.key] || 3;
            totalRiskScore += event.count * weight;
            maxPossibleScore += event.count * 10;
            
            if (weight >= 8) {
                highRiskEvents += event.count;
            }
        });

        const riskPercentage = Math.round((totalRiskScore / Math.max(maxPossibleScore, 1)) * 100);
        const riskLevel = riskPercentage >= 70 ? 'HOCH' : riskPercentage >= 40 ? 'MITTEL' : 'NIEDRIG';
        const riskClass = riskPercentage >= 70 ? 'high' : riskPercentage >= 40 ? 'medium' : 'low';

        this.insights.risk = {
            score: riskPercentage,
            level: riskLevel,
            class: riskClass,
            highRiskEvents: highRiskEvents,
            totalEvents: this.data.length,
            criticalTypes: eventsByType.filter(e => (riskWeights[e.key] || 0) >= 8)
        };
    }

    // 2. MUSTER-ERKENNUNG
    detectPatterns() {
        const patterns = [];
        
        // Standort-Hotspots erkennen
        const siteEvents = groupAndCount(this.data, row =>
            this.headerMap.site ? (row[this.headerMap.site] || "").trim() : ""
        );
        
        const avgEventsPerSite = this.data.length / siteEvents.length;
        const hotspots = siteEvents.filter(site => site.count > avgEventsPerSite * 1.5);
        
        if (hotspots.length > 0) {
            patterns.push({
                type: 'hotspot',
                title: 'Ereignis-Hotspots entdeckt',
                description: `${hotspots.length} Standorte mit √ºberdurchschnittlich vielen Ereignissen`,
                details: hotspots.slice(0, 3).map(h => `${h.key}: ${h.count} Ereignisse`),
                severity: hotspots[0].count > avgEventsPerSite * 2 ? 'high' : 'medium'
            });
        }

        // Wiederkehrende Ereignisarten
        const typeEvents = groupAndCount(this.data, row =>
            this.headerMap.type ? (row[this.headerMap.type] || "").trim() : ""
        );
        
        const dominantType = typeEvents[0];
        const typeConcentration = (dominantType.count / this.data.length) * 100;
        
        if (typeConcentration > 40) {
            patterns.push({
                type: 'concentration',
                title: 'Ereignis-Konzentration erkannt',
                description: `${Math.round(typeConcentration)}% aller Ereignisse sind "${dominantType.key}"`,
                details: [`M√∂glicherweise systematisches Problem`, `Pr√§ventionsma√ünahmen empfohlen`],
                severity: typeConcentration > 60 ? 'high' : 'medium'
            });
        }

        // Geografische Verteilung
        const countryEvents = groupAndCount(this.data, row =>
            this.headerMap.country ? (row[this.headerMap.country] || "").trim() : ""
        );
        
        if (countryEvents.length > 1) {
            const topCountry = countryEvents[0];
            const countryConcentration = (topCountry.count / this.data.length) * 100;
            
            if (countryConcentration > 70) {
                patterns.push({
                    type: 'geographic',
                    title: 'Geografische Konzentration',
                    description: `${Math.round(countryConcentration)}% der Ereignisse in ${topCountry.key}`,
                    details: [`Lokale Sicherheitsrichtlinien √ºberpr√ºfen`, `Regionsspezifische Ma√ünahmen erw√§gen`],
                    severity: 'medium'
                });
            }
        }

        this.insights.patterns = patterns;
    }

    // 3. EMPFEHLUNGEN GENERIEREN
    generateRecommendations() {
        const recommendations = [];
        const risk = this.insights.risk;
        const patterns = this.insights.patterns;

        // Risiko-basierte Empfehlungen
        if (risk.level === 'HOCH') {
            recommendations.push({
                priority: 'high',
                icon: 'üö®',
                title: 'Sofortige Sicherheitsma√ünahmen',
                action: 'Sicherheitsaudit durchf√ºhren und Notfallplan aktivieren',
                reason: `Risiko-Score von ${risk.score}% erfordert schnelles Handeln`
            });
        }

        if (risk.criticalTypes.length > 0) {
            recommendations.push({
                priority: 'high',
                icon: 'üîí',
                title: 'Kritische Ereignisarten adressieren',
                action: `Pr√§ventionsma√ünahmen f√ºr ${risk.criticalTypes[0].key} verst√§rken`,
                reason: `${risk.criticalTypes[0].count} kritische Ereignisse registriert`
            });
        }

        // Muster-basierte Empfehlungen
        patterns.forEach(pattern => {
            if (pattern.type === 'hotspot') {
                recommendations.push({
                    priority: pattern.severity === 'high' ? 'high' : 'medium',
                    icon: 'üìç',
                    title: 'Hotspot-Standorte √ºberwachen',
                    action: 'Zus√§tzliche Sicherheitsma√ünahmen an Brennpunkten implementieren',
                    reason: pattern.description
                });
            }
            
            if (pattern.type === 'concentration') {
                recommendations.push({
                    priority: 'medium',
                    icon: 'üéØ',
                    title: 'Gezieltes Training erforderlich',
                    action: 'Schulungen zum Hauptereignistyp durchf√ºhren',
                    reason: pattern.description
                });
            }
        });

        // Allgemeine Empfehlungen
        if (this.data.length > 20) {
            recommendations.push({
                priority: 'medium',
                icon: 'üìä',
                title: 'Regelm√§√üiges Monitoring',
                action: 'W√∂chentliche Dashboard-Reviews etablieren',
                reason: `${this.data.length} Ereignisse zeigen hohe Aktivit√§t`
            });
        }

        // Priorisierung
        recommendations.sort((a, b) => {
            const priorityOrder = { 'high': 3, 'medium': 2, 'low': 1 };
            return priorityOrder[b.priority] - priorityOrder[a.priority];
        });

        this.insights.recommendations = recommendations.slice(0, 4); // Top 4
    }

    // 4. TREND-PROGNOSE
    forecastTrends() {
        const trends = [];
        
        // Event-Frequenz-Analyse
        const avgEventsPerSite = this.data.length / new Set(this.data.map(row => 
            this.headerMap.site ? (row[this.headerMap.site] || "").trim() : ""
        )).size;
        
        // Risiko-Trend
        const riskTrend = this.insights.risk.score > 60 ? 'steigend' : 
                         this.insights.risk.score < 30 ? 'fallend' : 'stabil';
        
        trends.push({
            metric: 'Gesamt-Risiko',
            current: `${this.insights.risk.score}%`,
            forecast: riskTrend,
            confidence: '82%',
            recommendation: riskTrend === 'steigend' ? 'Verst√§rkte Pr√§ventionsma√ünahmen' : 'Aktuelles Niveau halten'
        });

        // Ereignis-Volumen Prognose
        const monthlyGrowth = this.data.length > 50 ? '+12%' : 
                            this.data.length > 20 ? '+5%' : '-3%';
        
        trends.push({
            metric: 'Ereignis-Volumen',
            current: `${this.data.length} Events`,
            forecast: `N√§chster Monat: ${monthlyGrowth}`,
            confidence: '75%',
            recommendation: monthlyGrowth.startsWith('+') ? 'Kapazit√§ten erh√∂hen' : 'Effizienz verbessern'
        });

        // Top-Risiko Prognose
        const topRiskType = this.insights.risk.criticalTypes[0];
        if (topRiskType) {
            trends.push({
                metric: topRiskType.key,
                current: `${topRiskType.count} Vorf√§lle`,
                forecast: 'Gleichbleibend hoch',
                confidence: '88%',
                recommendation: 'Spezifische Countermeasures implementieren'
            });
        }

        this.insights.trends = trends;
    }

    // 5. INSIGHTS RENDERN
    renderInsights() {
        this.renderRiskAssessment();
        this.renderPatternDetection();
        this.renderRecommendations();
        this.renderTrendForecast();
    }

    renderRiskAssessment() {
        const container = document.getElementById('riskAssessment');
        const risk = this.insights.risk;
        
        container.innerHTML = `
            <div class="insight-item risk-${risk.class}">
                <div class="insight-value">Risiko-Level: ${risk.level} (${risk.score}%)</div>
                <div class="insight-trend">
                    ${risk.highRiskEvents} kritische Ereignisse von ${risk.totalEvents} gesamt
                </div>
            </div>
            ${risk.criticalTypes.length > 0 ? `
                <div class="insight-item">
                    <div class="insight-value">‚ö†Ô∏è Kritischster Typ:</div>
                    <div class="insight-trend">${risk.criticalTypes[0].key} (${risk.criticalTypes[0].count}x)</div>
                </div>
            ` : ''}
        `;
    }

    renderPatternDetection() {
        const container = document.getElementById('patternDetection');
        const patterns = this.insights.patterns;
        
        if (patterns.length === 0) {
            container.innerHTML = `
                <div class="insight-item">
                    <div class="insight-value">‚úÖ Keine kritischen Muster erkannt</div>
                    <div class="insight-trend">Ereignisverteilung ist ausgewogen</div>
                </div>
            `;
            return;
        }

        container.innerHTML = patterns.slice(0, 2).map(pattern => `
            <div class="insight-item">
                <div class="insight-value">${pattern.severity === 'high' ? 'üî¥' : 'üü°'} ${pattern.title}</div>
                <div class="insight-trend">${pattern.description}</div>
            </div>
        `).join('');
    }

    renderRecommendations() {
        const container = document.getElementById('smartRecommendations');
        const recommendations = this.insights.recommendations;
        
        container.innerHTML = recommendations.slice(0, 3).map(rec => `
            <div class="insight-item">
                <div class="insight-value">${rec.icon} ${rec.title}</div>
                <div class="insight-trend">${rec.action}</div>
            </div>
        `).join('');
    }

    renderTrendForecast() {
        const container = document.getElementById('trendForecast');
        const trends = this.insights.trends;
        
        container.innerHTML = trends.slice(0, 3).map(trend => `
            <div class="insight-item">
                <div class="insight-value">${trend.metric}: ${trend.current}</div>
                <div class="insight-trend trend-${trend.forecast.includes('+') ? 'up' : trend.forecast.includes('-') ? 'down' : 'stable'}">
                    ${trend.forecast} (${trend.confidence} Konfidenz)
                </div>
            </div>
        `).join('');
    }
}

// Analytics in renderAll() einbauen
function runSmartAnalytics() {
    if (!currentData || currentData.length === 0) {
        // Clear insights if no data
        ['riskAssessment', 'patternDetection', 'smartRecommendations', 'trendForecast'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.innerHTML = '<div class="loading">Keine Daten f√ºr Analyse verf√ºgbar</div>';
            }
        });
        return;
    }

    const analytics = new SecurityAnalytics(currentData, headerMap);
    analytics.analyzeAll();
}
    // DOM Elements
    const loadTestDataBtn = document.getElementById('loadTestData');
    const fileInput = document.getElementById('fileInput');
    const fileStatus = document.getElementById('fileStatus');
     const exportCSVBtn = document.getElementById('exportCSV');
    const exportPDFBtn = document.getElementById('exportPDF');
    const filterCountry = document.getElementById('filterCountry');
    const filterSite = document.getElementById('filterSite');
    const filterType = document.getElementById('filterType');
    const resetFiltersBtn = document.getElementById('resetFilters');
    
    // Export Event Listeners
    exportCSVBtn.addEventListener('click', exportToCSV);
    exportPDFBtn.addEventListener('click', exportToPDF);
    
    // Filter Event Listeners
    filterCountry.addEventListener('change', applyFilters);
    filterSite.addEventListener('change', applyFilters);
    filterType.addEventListener('change', applyFilters);
    resetFiltersBtn.addEventListener('click', () => {
        filterCountry.value = "__ALL__";
        filterSite.value = "__ALL__";
        filterType.value = "__ALL__";
        applyFilters();
    });
    
    // Load Test Data
    loadTestDataBtn.addEventListener('click', function() {
        const csv = getTestData();
        const parsed = parseCSV(csv);
        allData = parsed.rows;
        headerMap = createHeaderMap(parsed.headers);
        currentData = allData;
        
        document.getElementById('recordCount').textContent = allData.length.toString();
        document.getElementById('modeIndicator').textContent = 'Modus: Testdaten (Demo)';
        document.getElementById('fileStatus').textContent = 'Testdaten sind geladen (Demo-Modus).';
        
        renderAll();
    });
    
    // CSV File Upload
    fileInput.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
            const text = await file.text();
            const parsed = parseCSV(text);
            allData = parsed.rows;
            headerMap = createHeaderMap(parsed.headers);
            currentData = allData;
            
            document.getElementById('recordCount').textContent = allData.length.toString();
            document.getElementById('modeIndicator').textContent = 'Modus: CSV-Datei';
            document.getElementById('fileStatus').textContent = `Datei "${file.name}" geladen. Datens√§tze: ${allData.length}.`;
            
            renderAll();
        } catch (err) {
            console.error(err);
            document.getElementById('fileStatus').textContent = 'Fehler beim Lesen der Datei.';
        }
    });
    
    // Apply Filters Function
    function applyFilters() {
        if (!allData || allData.length === 0) {
            currentData = [];
            renderAll();
            return;
        }

        const selCountry = filterCountry.value;
        const selSite = filterSite.value;
        const selType = filterType.value;

        currentData = allData.filter(row => {
            const rowCountry = headerMap.country ? (row[headerMap.country] || "").trim() : "";
            const rowSite = headerMap.site ? (row[headerMap.site] || "").trim() : "";
            const rowType = headerMap.type ? (row[headerMap.type] || "").trim() : "";

            if (selCountry !== "__ALL__" && rowCountry !== selCountry) return false;
            if (selSite !== "__ALL__" && rowSite !== selSite) return false;
            if (selType !== "__ALL__" && rowType !== selType) return false;
            return true;
        });

        updateFilterStatus();
        renderAll();
    }

    function updateFilterStatus() {
        const filterStatus = document.getElementById('filterStatus');
        const activeFilters = [];
        
        if (filterCountry.value !== "__ALL__") {
            activeFilters.push("Land: " + filterCountry.value);
        }
        if (filterSite.value !== "__ALL__") {
            activeFilters.push("Liegenschaft: " + filterSite.value);
        }
        if (filterType.value !== "__ALL__") {
            activeFilters.push("Ereignisart: " + filterType.value);
        }

        if (activeFilters.length === 0) {
            filterStatus.textContent = "Keine Filter aktiv (zeige alle Datens√§tze).";
        } else {
            filterStatus.textContent = "Aktive Filter: " + activeFilters.join(" | ");
        }
    }
    
    function renderAll() {
        renderKPIs();
        renderFiltersFromData();
        renderTables();
        renderCharts();
        runSmartAnalytics(); 
    }
    
    function renderKPIs() {
        const total = allData.length;
        const current = currentData.length;

        document.getElementById('kpiTotalEvents').textContent = total.toString();
        document.getElementById('kpiTotalEventsSub').textContent = `${current} nach Filter`;

        const countries = new Set();
        const sites = new Set();
        const types = new Set();

        for (const row of allData) {
            if (headerMap.country && row[headerMap.country]) {
                countries.add(row[headerMap.country].trim());
            }
            if (headerMap.site && row[headerMap.site]) {
                sites.add(row[headerMap.site].trim());
            }
            if (headerMap.type && row[headerMap.type]) {
                types.add(row[headerMap.type].trim());
            }
        }

        document.getElementById('kpiCountries').textContent = countries.size.toString();
        document.getElementById('kpiSites').textContent = sites.size.toString();
        document.getElementById('kpiTypes').textContent = types.size.toString();
    }

    function renderFiltersFromData() {
        const countries = new Set();
        const sites = new Set();
        const types = new Set();

        for (const row of allData) {
            if (headerMap.country && row[headerMap.country]) {
                countries.add(row[headerMap.country].trim());
            }
            if (headerMap.site && row[headerMap.site]) {
                sites.add(row[headerMap.site].trim());
            }
            if (headerMap.type && row[headerMap.type]) {
                types.add(row[headerMap.type].trim());
            }
        }

        updateSelectOptions(filterCountry, Array.from(countries).sort(), "Alle L√§nder");
        updateSelectOptions(filterSite, Array.from(sites).sort(), "Alle Liegenschaften");
        updateSelectOptions(filterType, Array.from(types).sort(), "Alle Ereignisarten");
    }

    function updateSelectOptions(select, values, placeholder) {
        const current = select.value;
        select.innerHTML = "";
        
        const optAll = document.createElement("option");
        optAll.value = "__ALL__";
        optAll.textContent = placeholder;
        select.appendChild(optAll);

        values.forEach(v => {
            const opt = document.createElement("option");
            opt.value = v;
            opt.textContent = v;
            select.appendChild(opt);
        });

        if (Array.from(select.options).some(o => o.value === current)) {
            select.value = current;
        }
    }
    
    function renderTables() {
        const tableByCountry = document.querySelector("#tableByCountry tbody");
        const tableBySite = document.querySelector("#tableBySite tbody");
        const tableByType = document.querySelector("#tableByType tbody");
        
        tableByCountry.innerHTML = "";
        tableBySite.innerHTML = "";
        tableByType.innerHTML = "";

        if (currentData.length === 0) return;

        const byCountry = groupAndCount(currentData, row =>
            headerMap.country ? (row[headerMap.country] || "").trim() : ""
        );
        byCountry.forEach(item => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${item.key || "(leer)"}</td>
                <td>${item.count}</td>
            `;
            tableByCountry.appendChild(tr);
        });

        // Sites Table with Country
        const siteMap = new Map();
        for (const row of currentData) {
            const site = headerMap.site ? (row[headerMap.site] || "").trim() : "";
            const country = headerMap.country ? (row[headerMap.country] || "").trim() : "";
            if (!site && !country) continue;
            const key = site + "||" + country;
            siteMap.set(key, (siteMap.get(key) || 0) + 1);
        }
        
        const siteArray = Array.from(siteMap.entries()).map(([key, count]) => {
            const [site, country] = key.split("||");
            return { site, country, count };
        }).sort((a, b) => b.count - a.count);

        siteArray.forEach(item => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${item.site || "(leer)"}</td>
                <td>${item.country || "(leer)"}</td>
                <td>${item.count}</td>
            `;
            tableBySite.appendChild(tr);
        });

        const byType = groupAndCount(currentData, row =>
            headerMap.type ? (row[headerMap.type] || "").trim() : ""
        );
        byType.forEach(item => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${item.key || "(leer)"}</td>
                <td>${item.count}</td>
            `;
            tableByType.appendChild(tr);
        });
    }
    
    function renderCharts() {
        const countries = groupAndCount(currentData, row =>
            headerMap.country ? (row[headerMap.country] || "").trim() : ""
        );
        createChart('chartCountries', countries, 'bar');

        const sites = groupAndCount(currentData, row =>
            headerMap.site ? (row[headerMap.site] || "").trim() : ""
        );
        createChart('chartSites', sites, 'bar');

        const types = groupAndCount(currentData, row =>
            headerMap.type ? (row[headerMap.type] || "").trim() : ""
        );
        createChart('chartTypes', types, 'pie');
        }
    }
        }
    });

    // ===== HIER EINF√úGEN (nach Zeile 1420, vor Zeile 1421) =====
    
    // =======================
    // THEME TOGGLE SYSTEM
    // =======================
    function initThemeToggle() {
        const themeToggle = document.getElementById('themeToggle');
        const themeLabel = document.querySelector('.theme-label');
        
        if (!themeToggle) return;
        
        // Load saved theme or default to light
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateThemeLabel(savedTheme);
        
        themeToggle.addEventListener('click', function() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeLabel(newTheme);
        });
        
        function updateThemeLabel(theme) {
            if (themeLabel) {
                themeLabel.textContent = theme === 'dark' ? 'Light Mode' : 'Dark Mode';
            }
        }
    }

    // Theme Toggle initialisieren
    initThemeToggle();
    
    // ===== BIS HIER =====
    
}); // <- Das bleibt (Zeile 1421)
</script>
});
</script>
</body>
</html>
