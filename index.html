container.innerHTML = patterns.slice(0, 2).map(pattern => `
            <div class="insight-item">
                <div class="insight-value">${pattern.severity === 'high' ? 'ðŸ”´' : 'ðŸŸ¡'} ${pattern.title}</div>
                <div class="insight-trend">${pattern.description}</div>
            </div>
        `).join('');
    }

    renderRecommendations() {
        const container = document.getElementById('smartRecommendations');
        const recommendations = this.insights.recommendations;
        
        container.innerHTML = recommendations.slice(0, 3).map(rec => `
            <div class="insight-item">
                <div class="insight-value">${rec.icon} ${rec.title}</div>
                <div class="insight-trend">${rec.action}</div>
            </div>
        `).join('');
    }

    renderTrendForecast() {
        const container = document.getElementById('trendForecast');
        const trends = this.insights.trends;
        
        container.innerHTML = trends.slice(0, 3).map(trend => `
            <div class="insight-item">
                <div class="insight-value">${trend.metric}: ${trend.current}</div>
                <div class="insight-trend trend-${trend.forecast.includes('+') ? 'up' : trend.forecast.includes('-') ? 'down' : 'stable'}">
                    ${trend.forecast} (${trend.confidence} Konfidenz)
                </div>
            </div>
        `).join('');
    }
}

function runSmartAnalytics() {
    if (!currentData || currentData.length === 0) {
        ['riskAssessment', 'patternDetection', 'smartRecommendations', 'trendForecast'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.innerHTML = '<div class="loading">Keine Daten fÃ¼r Analyse verfÃ¼gbar</div>';
            }
        });
        return;
    }

    const analytics = new SecurityAnalytics(currentData, headerMap);
    analytics.analyzeAll();
}

// =======================
// THEME TOGGLE SYSTEM
// =======================
function initThemeToggle() {
    const themeToggle = document.getElementById('themeToggle');
    const themeLabel = document.querySelector('.theme-label');
    
    if (!themeToggle) return;
    
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeLabel(savedTheme);
    
    themeToggle.addEventListener('click', function() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeLabel(newTheme);
    });
    
    function updateThemeLabel(theme) {
        if (themeLabel) {
            themeLabel.textContent = theme === 'dark' ? 'Light Mode' : 'Dark Mode';
        }
    }
}

// =======================
// MAIN APPLICATION
// =======================
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard ready!');
    
    // Initialize Theme Toggle
    initThemeToggle();
    
    // DOM Elements
    const loadTestDataBtn = document.getElementById('loadTestData');
    const fileInput = document.getElementById('fileInput');
    const fileStatus = document.getElementById('fileStatus');
    const exportCSVBtn = document.getElementById('exportCSV');
    const exportPDFBtn = document.getElementById('exportPDF');
    const filterCountry = document.getElementById('filterCountry');
    const filterSite = document.getElementById('filterSite');
    const filterType = document.getElementById('filterType');
    const resetFiltersBtn = document.getElementById('resetFilters');
    
    // Export Event Listeners
    exportCSVBtn.addEventListener('click', exportToCSV);
    exportPDFBtn.addEventListener('click', exportToPDF);
    
    // Filter Event Listeners
    filterCountry.addEventListener('change', applyFilters);
    filterSite.addEventListener('change', applyFilters);
    filterType.addEventListener('change', applyFilters);
    resetFiltersBtn.addEventListener('click', () => {
        filterCountry.value = "__ALL__";
        filterSite.value = "__ALL__";
        filterType.value = "__ALL__";
        applyFilters();
    });
    
    // Load Test Data
    loadTestDataBtn.addEventListener('click', function() {
        const csv = getTestData();
        const parsed = parseCSV(csv);
        allData = parsed.rows;
        headerMap = createHeaderMap(parsed.headers);
        currentData = allData;
        
        document.getElementById('recordCount').textContent = allData.length.toString();
        document.getElementById('modeIndicator').textContent = 'Modus: Testdaten (Demo)';
        document.getElementById('fileStatus').textContent = 'Testdaten sind geladen (Demo-Modus).';
        
        renderAll();
    });
    
    // CSV File Upload
    fileInput.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
            const text = await file.text();
            const parsed = parseCSV(text);
            allData = parsed.rows;
            headerMap = createHeaderMap(parsed.headers);
            currentData = allData;
            
            document.getElementById('recordCount').textContent = allData.length.toString();
            document.getElementById('modeIndicator').textContent = 'Modus: CSV-Datei';
            document.getElementById('fileStatus').textContent = `Datei "${file.name}" geladen. DatensÃ¤tze: ${allData.length}.`;
            
            renderAll();
        } catch (err) {
            console.error(err);
            document.getElementById('fileStatus').textContent = 'Fehler beim Lesen der Datei.';
        }
    });
    
    // Apply Filters Function
    function applyFilters() {
        if (!allData || allData.length === 0) {
            currentData = [];
            renderAll();
            return;
        }

        const selCountry = filterCountry.value;
        const selSite = filterSite.value;
        const selType = filterType.value;

        currentData = allData.filter(row => {
            const rowCountry = headerMap.country ? (row[headerMap.country] || "").trim() : "";
            const rowSite = headerMap.site ? (row[headerMap.site] || "").trim() : "";
            const rowType = headerMap.type ? (row[headerMap.type] || "").trim() : "";

            if (selCountry !== "__ALL__" && rowCountry !== selCountry) return false;
            if (selSite !== "__ALL__" && rowSite !== selSite) return false;
            if (selType !== "__ALL__" && rowType !== selType) return false;
            return true;
        });

        updateFilterStatus();
        renderAll();
    }

    function updateFilterStatus() {
        const filterStatus = document.getElementById('filterStatus');
        const activeFilters = [];
        
        if (filterCountry.value !== "__ALL__") {
            activeFilters.push("Land: " + filterCountry.value);
        }
        if (filterSite.value !== "__ALL__") {
            activeFilters.push("Liegenschaft: " + filterSite.value);
        }
        if (filterType.value !== "__ALL__") {
            activeFilters.push("Ereignisart: " + filterType.value);
        }

        if (activeFilters.length === 0) {
            filterStatus.textContent = "Keine Filter aktiv (zeige alle DatensÃ¤tze).";
        } else {
            filterStatus.textContent = "Aktive Filter: " + activeFilters.join(" | ");
        }
    }
    
    function renderAll() {
        renderKPIs();
        renderFiltersFromData();
        renderTables();
        renderCharts();
        runSmartAnalytics(); 
    }
    
    function renderKPIs() {
        const total = allData.length;
        const current = currentData.length;

        document.getElementById('kpiTotalEvents').textContent = total.toString();
        document.getElementById('kpiTotalEventsSub').textContent = `${current} nach Filter`;

        const countries = new Set();
        const sites = new Set();
        const types = new Set();

        for (const row of allData) {
            if (headerMap.country && row[headerMap.country]) {
                countries.add(row[headerMap.country].trim());
            }
            if (headerMap.site && row[headerMap.site]) {
                sites.add(row[headerMap.site].trim());
            }
            if (headerMap.type && row[headerMap.type]) {
                types.add(row[headerMap.type].trim());
            }
        }

        document.getElementById('kpiCountries').textContent = countries.size.toString();
        document.getElementById('kpiSites').textContent = sites.size.toString();
        document.getElementById('kpiTypes').textContent = types.size.toString();
    }

    function renderFiltersFromData() {
        const countries = new Set();
        const sites = new Set();
        const types = new Set();

        for (const row of allData) {
            if (headerMap.country && row[headerMap.country]) {
                countries.add(row[headerMap.country].trim());
            }
            if (headerMap.site && row[headerMap.site]) {
                sites.add(row[headerMap.site].trim());
            }
            if (headerMap.type && row[headerMap.type]) {
                types.add(row[headerMap.type].trim());
            }
        }

        updateSelectOptions(filterCountry, Array.from(countries).sort(), "Alle LÃ¤nder");
        updateSelectOptions(filterSite, Array.from(sites).sort(), "Alle Liegenschaften");
        updateSelectOptions(filterType, Array.from(types).sort(), "Alle Ereignisarten");
    }

    function updateSelectOptions(select, values, placeholder) {
        const current = select.value;
        select.innerHTML = "";
        
        const optAll = document.createElement("option");
        optAll.value = "__ALL__";
        optAll.textContent = placeholder;
        select.appendChild(optAll);

        values.forEach(v => {
            const opt = document.createElement("option");
            opt.value = v;
            opt.textContent = v;
            select.appendChild(opt);
        });

        if (Array.from(select.options).some(o => o.value === current)) {
            select.value = current;
        }
    }
    
    function renderTables() {
        const tableByCountry = document.querySelector("#tableByCountry tbody");
        const tableBySite = document.querySelector("#tableBySite tbody");
        const tableByType = document.querySelector("#tableByType tbody");
        
        tableByCountry.innerHTML = "";
        tableBySite.innerHTML = "";
        tableByType.innerHTML = "";

        if (currentData.length === 0) return;

        const byCountry = groupAndCount(currentData, row =>
            headerMap.country ? (row[headerMap.country] || "").trim() : ""
        );
        byCountry.forEach(item => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${item.key || "(leer)"}</td>
                <td>${item.count}</td>
            `;
            tableByCountry.appendChild(tr);
        });

        // Sites Table with Country
        const siteMap = new Map();
        for (const row of currentData) {
            const site = headerMap.site ? (row[headerMap.site] || "").trim() : "";
            const country = headerMap.country ? (row[headerMap.country] || "").trim() : "";
            if (!site && !country) continue;
            const key = site + "||" + country;
            siteMap.set(key, (siteMap.get(key) || 0) + 1);
        }
        
        const siteArray = Array.from(siteMap.entries()).map(([key, count]) => {
            const [site, country] = key.split("||");
            return { site, country, count };
        }).sort((a, b) => b.count - a.count);

        siteArray.forEach(item => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${item.site || "(leer)"}</td>
                <td>${item.country || "(leer)"}</td>
                <td>${item.count}</td>
            `;
            tableBySite.appendChild(tr);
        });

        const byType = groupAndCount(currentData, row =>
            headerMap.type ? (row[headerMap.type] || "").trim() : ""
        );
        byType.forEach(item => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${item.key || "(leer)"}</td>
                <td>${item.count}</td>
            `;
            tableByType.appendChild(tr);
        });
    }
    
    function renderCharts() {
        const countries = groupAndCount(currentData, row =>
            headerMap.country ? (row[headerMap.country] || "").trim() : ""
        );
        createChart('chartCountries', countries, 'bar');

        const sites = groupAndCount(currentData, row =>
            headerMap.site ? (row[headerMap.site] || "").trim() : ""
        );
        createChart('chartSites', sites, 'bar');

        const types = groupAndCount(currentData, row =>
            headerMap.type ? (row[headerMap.type] || "").trim() : ""
        );
        createChart('chartTypes', types, 'pie');
    }
});
</script>

</body>
</html>
