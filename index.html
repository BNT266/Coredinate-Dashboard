<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Event Dashboard</title>
    <link rel="stylesheet" href="src/css/styles.css">
    
    <!-- DEBUG PANEL STYLES -->
    <style>
        #debugPanel {
            position: fixed;
            top: 10px;
            left: 10px;
            width: 400px;
            max-height: 300px;
            background: #1a1a2e;
            color: #0f0;
            font-family: monospace;
            font-size: 11px;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #0f0;
            z-index: 99999;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,255,0,0.3);
        }
        #debugPanel h4 {
            margin: 0 0 8px 0;
            color: #0f0;
            font-size: 12px;
            border-bottom: 1px solid #0f0;
            padding-bottom: 5px;
        }
        #debugPanel .error { color: #ff4444; }
        #debugPanel .success { color: #44ff44; }
        #debugPanel .info { color: #44aaff; }
        #debugPanel .warn { color: #ffaa00; }
        #debugLog div {
            padding: 2px 0;
            border-bottom: 1px solid #333;
        }
        #closeDebug {
            position: absolute;
            top: 5px;
            right: 8px;
            background: #ff4444;
            color: white;
            border: none;
            padding: 2px 8px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 10px;
        }
    </style>
</head>
<body>

<!-- ============================================= -->
<!-- DEBUG PANEL - Zeigt Fehler an -->
<!-- ============================================= -->
<div id="debugPanel">
    <button id="closeDebug" onclick="this.parentElement.style.display='none'">X</button>
    <h4>üîß DEBUG KONSOLE</h4>
    <div id="debugLog"></div>
</div>

<script>
    // Debug Logger - f√§ngt alle Fehler ab
    const debugLog = document.getElementById('debugLog');
    
    function logDebug(msg, type = 'info') {
        const div = document.createElement('div');
        div.className = type;
        div.textContent = new Date().toLocaleTimeString() + ' - ' + msg;
        debugLog.insertBefore(div, debugLog.firstChild);
    }
    
    // Alle Fehler abfangen
    window.onerror = function(msg, url, line, col, error) {
        logDebug('ERROR: ' + msg + ' (Zeile ' + line + ')', 'error');
        return false;
    };
    
    // Promise-Fehler abfangen
    window.onunhandledrejection = function(e) {
        logDebug('PROMISE ERROR: ' + e.reason, 'error');
    };
    
    // Console.log √ºberschreiben
    const origLog = console.log;
    console.log = function(...args) {
        logDebug(args.join(' '), 'info');
        origLog.apply(console, args);
    };
    
    const origError = console.error;
    console.error = function(...args) {
        logDebug(args.join(' '), 'error');
        origError.apply(console, args);
    };
    
    const origWarn = console.warn;
    console.warn = function(...args) {
        logDebug(args.join(' '), 'warn');
        origWarn.apply(console, args);
    };
    
    logDebug('Debug Panel gestartet', 'success');
</script>

<!-- ============================================= -->
<!-- PR√úFE OB EXTERNE SCRIPTS LADEN -->
<!-- ============================================= -->
<script>
    logDebug('Lade Chart.js...', 'info');
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js" 
        onload="logDebug('‚úÖ Chart.js geladen', 'success')" 
        onerror="logDebug('‚ùå Chart.js FEHLER - Blocked?', 'error')"></script>

<script>
    logDebug('Lade jsPDF...', 'info');
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
        onload="logDebug('‚úÖ jsPDF geladen', 'success')"
        onerror="logDebug('‚ùå jsPDF FEHLER - Blocked?', 'error')"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"
        onload="logDebug('‚úÖ jsPDF-AutoTable geladen', 'success')"
        onerror="logDebug('‚ùå jsPDF-AutoTable FEHLER', 'error')"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
        onload="logDebug('‚úÖ html2canvas geladen', 'success')"
        onerror="logDebug('‚ùå html2canvas FEHLER', 'error')"></script>

<!-- ============================================= -->
<!-- HAUPT-APP -->
<!-- ============================================= -->
<div class="app-shell">
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="brand">SECURITY<span>DASH</span></div>
            <div class="subtitle">Security Events Management Dashboard</div>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title">Datenquelle</div>
            <div class="file-input-wrapper">
                <label for="fileInput">
                    CSV-Datei f√ºr Ereignismeldungen ausw√§hlen
                    <input type="file" id="fileInput" accept=".csv">
                </label>
            </div>
            <div class="hint">
                Erwartete Spalten z.B.: <strong>Land, Liegenschaft, Ereignisart, Datum</strong>
            </div>
            <div id="fileStatus" class="status">Keine Datei geladen.</div>
            <button type="button" class="btn outline-light" id="loadTestData">
                Testdaten laden (Demo-Modus)
            </button>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title">Filter</div>
            <div class="filters">
                <div class="filter-row">
                    <label for="filterCountry">Land</label>
                    <select id="filterCountry">
                        <option value="__ALL__">Alle L√§nder</option>
                    </select>
                </div>
                <div class="filter-row">
                    <label for="filterSite">Liegenschaft</label>
                    <select id="filterSite">
                        <option value="__ALL__">Alle Liegenschaften</option>
                    </select>
                </div>
                <div class="filter-row">
                    <label for="filterType">Ereignisart</label>
                    <select id="filterType">
                        <option value="__ALL__">Alle Ereignisarten</option>
                    </select>
                </div>
                <button type="button" class="btn secondary" id="resetFilters">
                    Filter zur√ºcksetzen
                </button>
                <div id="filterStatus" class="status"></div>
            </div>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title">Export</div>
            <button type="button" class="btn secondary" id="exportCSV">
                üìÑ CSV exportieren
            </button>
            <button type="button" class="btn primary" id="exportPDF">
                üìä Executive PDF-Report erstellen
            </button>
            <div id="exportStatus" class="status" style="display: none;"></div>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title">Risiko-Konfiguration</div>
            <div id="riskConfigContainer" class="risk-config"></div>
        </div>
    </aside>

    <main class="main">
        <div class="top-bar">
            <div class="theme-toggle-wrapper">
                <button type="button" id="themeToggle" class="theme-toggle" title="Dark/Light Mode umschalten">
                    <span class="theme-icon sun">‚òÄÔ∏è</span>
                    <span class="theme-icon moon">üåô</span>
                    <div class="theme-toggle-slider"></div>
                </button>
                <span class="theme-label">Dark Mode</span>
            </div>

            <div class="language-select-wrapper">
                <label for="reportLanguage">Report-Sprache:</label>
                <select id="reportLanguage">
                    <option value="de" selected>Deutsch</option>
                    <option value="en">English</option>
                </select>
            </div>
        </div>

        <header class="main-header">
            <div>
                <h1>Security Events Overview</h1>
                <p class="main-header-subtitle">
                    Echtzeit-√úbersicht √ºber gemeldete Ereignisse nach Land, Liegenschaft und Ereignisart
                </p>
            </div>
            <div class="main-header-right">
                <div class="pill">
                    <span id="recordCount">0</span> Datens√§tze geladen
                </div>
                <div class="pill secondary" id="modeIndicator">Modus: Keine Daten</div>
            </div>
        </header>

        <section class="card-grid">
            <article class="card">
                <div class="card-title">Gesamtzahl Ereignisse</div>
                <div class="card-value" id="kpiTotalEvents">0</div>
                <div class="card-subvalue" id="kpiTotalEventsSub">0 nach Filter</div>
            </article>
            <article class="card">
                <div class="card-title">L√§nder</div>
                <div class="card-value" id="kpiCountries">0</div>
                <div class="card-subvalue">Distinct nach Feld ‚ÄûLand"</div>
            </article>
            <article class="card">
                <div class="card-title">Liegenschaften</div>
                <div class="card-value" id="kpiSites">0</div>
                <div class="card-subvalue">Distinct nach Feld ‚ÄûLiegenschaft"</div>
            </article>
            <article class="card">
                <div class="card-title">Ereignisarten</div>
                <div class="card-value" id="kpiTypes">0</div>
                <div class="card-subvalue">Distinct nach Feld ‚ÄûEreignisart"</div>
            </article>
        </section>

        <section class="analytics-panel">
            <div class="panel-header">
                <div>
                    <h2 class="panel-title">üß† Smart Analytics &amp; Insights</h2>
                    <p class="panel-subtitle">
                        KI-basierte Muster-Erkennung und automatische Sicherheitsanalyse
                    </p>
                </div>
            </div>
            <div class="insights-grid">
                <article class="insight-card">
                    <div class="insight-header">
                        <span class="insight-icon">‚ö†Ô∏è</span>
                        <h3>Risiko-Assessment</h3>
                    </div>
                    <div id="riskAssessment" class="insight-content">
                        <div class="loading">Analysiere Risiko-Muster...</div>
                    </div>
                </article>
                <article class="insight-card">
                    <div class="insight-header">
                        <span class="insight-icon">üîç</span>
                        <h3>Muster-Erkennung</h3>
                    </div>
                    <div id="patternDetection" class="insight-content">
                        <div class="loading">Suche nach Anomalien...</div>
                    </div>
                </article>
                <article class="insight-card">
                    <div class="insight-header">
                        <span class="insight-icon">üí°</span>
                        <h3>Empfehlungen</h3>
                    </div>
                    <div id="smartRecommendations" class="insight-content">
                        <div class="loading">Generiere Handlungsempfehlungen...</div>
                    </div>
                </article>
                <article class="insight-card">
                    <div class="insight-header">
                        <span class="insight-icon">üìà</span>
                        <h3>Trend-Prognose</h3>
                    </div>
                    <div id="trendForecast" class="insight-content">
                        <div class="loading">Berechne Zukunftstrends...</div>
                    </div>
                </article>
            </div>
        </section>

        <div class="content-grid">
            <section class="panel">
                <div class="panel-header">
                    <div>
                        <h2 class="panel-title">Aggregierte √úbersicht</h2>
                        <p class="panel-subtitle">
                            H√§ufigkeiten nach Land, Liegenschaft und Ereignisart
                        </p>
                    </div>
                </div>

                <h3>Nach Land</h3>
                <div class="table-wrapper">
                    <table id="tableByCountry">
                        <thead>
                        <tr>
                            <th>Land</th>
                            <th>Anzahl Ereignisse</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <h3>Nach Liegenschaft</h3>
                <div class="table-wrapper">
                    <table id="tableBySite">
                        <thead>
                        <tr>
                            <th>Liegenschaft</th>
                            <th>Land</th>
                            <th>Anzahl Ereignisse</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <h3>Nach Ereignisart</h3>
                <div class="table-wrapper">
                    <table id="tableByType">
                        <thead>
                        <tr>
                            <th>Ereignisart</th>
                            <th>Anzahl Ereignisse</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <section class="panel">
                <div class="panel-header">
                    <div>
                        <h2 class="panel-title">Visualisierung &amp; Benchmark</h2>
                        <p class="panel-subtitle">
                            Top-L√§nder, Liegenschaften und Ereignisarten nach H√§ufigkeit
                        </p>
                    </div>
                </div>

                <h3>Top L√§nder</h3>
                <div id="chartCountries" class="chart"></div>

                <h3>Top Liegenschaften</h3>
                <div id="chartSites" class="chart"></div>

                <h3>Top Ereignisarten</h3>
                <div id="chartTypes" class="chart"></div>

                <h3>Bereichsverteilung</h3>
                <div id="chartDomains" class="chart"></div>
            </section>
        </div>
    </main>
</div>

<div id="toastContainer" class="toast-container"></div>

<!-- Pr√ºfe ob app.js l√§dt -->
<script>
    logDebug('Lade app.js...', 'info');
</script>
<script src="src/js/app.js" 
        onload="logDebug('‚úÖ app.js geladen', 'success')"
        onerror="logDebug('‚ùå app.js FEHLER - Datei nicht gefunden?', 'error')"></script>

<script>
    // Finale Pr√ºfung nach 2 Sekunden
    setTimeout(function() {
        logDebug('--- FINALE PR√úFUNG ---', 'info');
        
        if (typeof Chart === 'undefined') {
            logDebug('‚ùå Chart.js ist NICHT verf√ºgbar (evtl. vom Firmennetzwerk blockiert)', 'error');
        } else {
            logDebug('‚úÖ Chart.js verf√ºgbar', 'success');
        }
        
        if (typeof Dashboard === 'undefined') {
            logDebug('‚ùå Dashboard ist NICHT definiert - app.js hat Fehler', 'error');
        } else {
            logDebug('‚úÖ Dashboard verf√ºgbar', 'success');
        }
        
        if (typeof jspdf === 'undefined' && typeof window.jspdf === 'undefined') {
            logDebug('‚ö†Ô∏è jsPDF nicht verf√ºgbar - PDF-Export geht nicht', 'warn');
        } else {
            logDebug('‚úÖ jsPDF verf√ºgbar', 'success');
        }
        
    }, 2000);
</script>

</body>
</html>
